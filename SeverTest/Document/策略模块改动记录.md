# 策略模块改动记录（官方策略 / 策略模板 / 策略广场 / 推荐）

## 1. 新增数据表（MySQL）

### 1.1 官方策略
- 表：`official_strategy_def`
  - `def_id` bigint unsigned PK AI：官方策略定义 ID
  - `creator_uid` bigint unsigned：创建者（官方维护者）
  - `source_us_id` bigint unsigned：来源用户策略实例（用于同步/移除）
  - `def_type` varchar(16)：固定为 `official`
  - `name` varchar(64)：名称
  - `description` varchar(255)：描述
  - `latest_version_id` bigint unsigned：最新版本
  - `created_at` datetime(3)
  - `updated_at` datetime(3)
  - 索引：`uk_source_us`(source_us_id) 防止同一实例重复发布
- 表：`official_strategy_version`
  - `version_id` bigint unsigned PK AI
  - `def_id` bigint unsigned：引用 `official_strategy_def`
  - `version_no` int：版本号
  - `content_hash` char(64)：配置哈希
  - `config_json` json：策略配置
  - `artifact_uri` varchar(512) 可空
  - `changelog` varchar(255)
  - `created_by` bigint unsigned
  - `created_at` datetime(3)

### 1.2 策略模板
- 表：`template_strategy_def`
  - `def_id` bigint unsigned PK AI：模板定义 ID
  - `creator_uid` bigint unsigned
  - `source_us_id` bigint unsigned：来源用户策略实例（用于同步/移除）
  - `def_type` varchar(16)：固定为 `template`
  - `name` varchar(64)
  - `description` varchar(255)
  - `latest_version_id` bigint unsigned
  - `created_at` datetime(3)
  - `updated_at` datetime(3)
  - 索引：`uk_source_us`(source_us_id) 防止同一实例重复发布
- 表：`template_strategy_version`
  - `version_id` bigint unsigned PK AI
  - `def_id` bigint unsigned：引用 `template_strategy_def`
  - `version_no` int
  - `content_hash` char(64)
  - `config_json` json
  - `artifact_uri` varchar(512) 可空
  - `changelog` varchar(255)
  - `created_by` bigint unsigned
  - `created_at` datetime(3)

### 1.3 策略广场
- 表：`strategy_market`
  - `market_id` bigint unsigned PK AI
  - `us_id` bigint unsigned：用户策略实例 ID
  - `uid` bigint unsigned：发布用户 ID
  - `def_id` bigint unsigned
  - `pinned_version_id` bigint unsigned
  - `title` varchar(64)
  - `description` varchar(255)
  - `created_at` datetime(3)
  - `updated_at` datetime(3)
  - 索引：`uk_us`(us_id) 防止重复公开

## 2. 新增/调整接口（后端）

### 2.1 官方策略 / 策略模板
- `GET /api/strategy/official/list`
  - 返回官方策略列表（含最新版本 config_json）
- `GET /api/strategy/official/versions?defId=`
  - 返回官方策略历史版本（用于详情查看/选择版本）
- `GET /api/strategy/template/list`
  - 返回策略模板列表（含最新版本 config_json）
- `POST /api/strategy/publish/official`
  - 超级管理发布自己的策略为官方策略
- `POST /api/strategy/publish/template`
  - 超级管理发布自己的策略为模板
- `POST /api/strategy/official/sync`
  - 超级管理一键同步最新版本到官方策略
- `POST /api/strategy/template/sync`
  - 超级管理一键同步最新版本到策略模板
- `POST /api/strategy/official/remove`
  - 超级管理将策略从官方策略库移除
- `POST /api/strategy/template/remove`
  - 超级管理将策略从模板库移除

> 权限：仅 `role=255` 允许发布/同步/移除官方策略与模板。

### 2.2 策略广场
- `GET /api/strategy/market/list`
  - 返回策略广场公开列表
- `POST /api/strategy/market/publish`
  - 用户公开自己的策略到广场
  - 同步更新 `user_strategy.visibility = 'public'`
- `POST /api/strategy/market/sync`
  - 用户一键同步最新版本到策略广场

### 2.3 登录返回 role
- `POST /api/auth/login`
  - 返回 `role`（前端用于展示权限与超级管理入口）

## 3. 前端功能变更

### 3.1 策略详情页（StrategyDetailDialog）
- 新增按钮：
  - **公开到策略广场**（所有用户）
  - **发布为官方策略 / 发布为策略模板**（仅超级管理）
  - **发布最新版本到官方/模板/广场**
  - **从官方策略中移除 / 从策略模板中移除**（仅超级管理）
- 所有发布/同步/移除动作均有确认弹窗
- 新增页签：**回测**，支持填写回测参数并调用 `backtest.run` 展示回测结果
- 回测结果区新增“全屏显示”专用界面：
  - 点击全屏按钮后弹出独立回测工作台（遮罩层）
  - 左侧固定为 `MarketChart` 行情组件（按回测交易所/标的/周期映射）
  - 右侧保留现有回测结果明细（汇总统计、分标的交易/资金曲线/事件日志）
  - 支持点击遮罩或按 `Esc` 退出全屏界面
- 回测结果“交易明细”支持仓位点击联动：
  - 点击某条回测仓位后，前端会按该仓位开平仓时间向后端请求对应时间段 K 线（额外增加前后缓冲区间）
  - 图表切换到该仓位交易对/周期，并在图中以矩形高亮该仓位时间区间（不再绘制开/平仓竖线）
  - 支持在结果表中高亮当前已选仓位，便于对照阅读
  - 仓位聚焦后会根据区间起止时间点在画布中的像素坐标进行二次偏移校准，尽量将该仓位区间居中显示在图表中部
- 回测联动链路新增前端调试日志（开发环境）：
  - `StrategyDetailDialog` 输出仓位点击、focusRange 状态变化、全屏打开关闭、`backtest.run` / `backtest.progress` / `marketdata.cache.snapshots` 协议收发日志
  - `MarketChart` 输出 `marketdata.kline.history` 协议发送与响应、focusRange 请求参数、K 线开始绘制/完成绘制、覆盖层创建、滚动定位与异常日志
  - 日志统一前缀：`[BacktestTrace]` 与 `[KlinechartsTrace]`，用于在浏览器控制台快速筛选定位问题
- `MarketChart` 合并后问题修复（2026-02-09）：
  - 修复 `WAVE_TOOL_ICON_MAP` 合并缺失闭合导致的 `MarketChart.tsx` 语法编译失败。
  - 引入历史/焦点加载“数据版本号”保护，避免普通历史请求与焦点请求并发完成时互相覆盖。
  - 焦点模式退出统一恢复：当 `focusRange` 清空、symbol/interval 不匹配、区间非法或焦点请求失败时，自动退出焦点模式并回退常规历史窗口，恢复实时行情更新。
  - 修复绘图工具图标崩溃：当 SVG import 返回 `data:image/svg+xml` 字符串时，不再按 JSX 组件标签渲染，统一走 URL 回退渲染，避免 `createElement` 抛出 `InvalidCharacterError`。
  - `vite-plugin-svgr` 调整为显式 `include: "**/*.svg?react"`，确保 `?react` 导入路径优先走组件转换链路。
- `MarketChart` 指标显示策略调整（2026-02-11）：
  - 默认创建 `MA250`（主图）+ `MACD`、`VOL`（副图）。
  - 指标选择面板继续保留完整主图/副图列表，支持手动添加与切换其它指标。
- `MarketChart` 指标参数编辑器卡死修复（2026-02-14）：
  - 现象：在指标参数编辑弹窗中修改参数并确认（如 `MA250 -> 30`、`MACD` 参数调整）后，图表出现不刷新、拖拽失效。
  - 根因：保存时将 `chart.getIndicatorByPaneId(...).styles` 的原始对象引用回传给 `overrideIndicator`，触发 `klinecharts` 内部 `merge` 的同引用递归，导致主线程卡死。
  - 修复：编辑器打开时对 `styles` 做深拷贝快照；保存时基于快照构造 `styles`，确保与图表内部样式对象无共享引用后再调用 `overrideIndicator`。
  - 影响范围：主图/副图所有支持参数编辑的指标（含 `ta_MA`、`ta_MACD`、内置 `MACD` 等）。
- `MarketChart` 刷新问题限定日志增强（2026-02-14）：
  - 新增统一前缀日志：`K线图表刷新问题排查：*****`，用于控制台筛选刷新链路。
  - 新增链路日志点：图表初始化、默认指标创建、历史 `applyNewData`、`loadMore` 回调、WS `updateData` 汇总、焦点模式进出、指标编辑器打开/关闭、`overrideIndicator` 保存前后与延迟复核（120ms/800ms）。
  - 新增日志开关：`localStorage["__DWQ_KLINE_REFRESH_DIAG__"] = "0"` 可关闭该限定日志（开发环境默认开启）。
  - 回归修复：初始化 effect 依赖恢复为 `talibReady`，避免依赖变更触发 cleanup 后误取消 `OnTooltipIconClick` 订阅，导致指标“设置”图标无法弹出参数编辑器。
  - 日志细化：保存指标参数时新增“保存前实例快照 / 立即状态 / rAF 两帧状态 / 延迟状态”输出，含 `calcParams`、`resultCount`、`styleLineCount`、`dataVersion`、`focusMode`，用于判断“参数已落地但图表未重绘”还是“参数未真正应用”。
  - 参数保存链路增强：`overrideIndicator` 增加 callback，在回调中输出状态并对当前数据执行一次 `applyNewData` 强制重绘；样式保存改为仅提交 `styles.lines` 最小集合，避免整包样式合并带来的潜在副作用。
  - `ta_` 指标保存新增兜底策略：参数确认时改为“按原 pane 删除后重建同名指标（携带新参数与样式）”，绕过 `overrideIndicator` 在自定义指标上的潜在不一致；并新增 `immediate/plain/post-check-plain` 日志直接输出关键数值，降低控制台对象折叠导致的排查成本。
  - 交互回归修正：保存后重绘策略由 `applyNewData` 调整为 `resize()`（通过 rAF 触发），避免视图被重置到最新位置并影响拖拽体验；新增 `OnPaneDrag` / `OnScroll` 限流日志，直接观测拖拽事件是否进入图表内核。
- 修复回测仓位联动时 `marketdata.kline.history` 400 参数校验失败：
  - 后端 `Program.cs` 为 HTTP 控制器启用 `ProtocolJson` 统一序列化配置
  - `exchange/timeframe/symbol` 现支持字符串枚举入参并保持大小写不敏感，与 WS 行为一致
- `MarketChart` 标准化重构（2026-02-14）：
  - 前端 `Client/src/components/MarketChart.tsx` 改为单组件完整实现，生命周期统一为 `init -> applyNewData/updateData -> dispose`，对齐官方 React 示例模式。
  - 保留完整能力集合：交易对/周期切换、主题切换、K 线类型切换、Y 轴模式、语言与时区切换、主副图指标管理、绘图工具、截图、全屏。
  - 保留数据链路：`marketdata.kline.history` 历史拉取、左滑 `LoadDataType.Forward` 继续加载、`subscribeMarket` 实时更新当前 K 线。
  - 保留回测联动：继续支持 `focusRange`（按需切换 symbol/interval、区间高亮、开平仓/止盈止损价格线、自动滚动与缩放定位）。
  - 精简内容：移除超大规模的自定义指标参数编辑器与诊断日志链路，降低组件复杂度，优先保障稳定性与可维护性。
  - 指标操作补齐（2026-02-14）：新增“指标列表”区块，针对每个已启用指标提供 `隐藏/显示`、`设置`、`删除` 三个按钮；`设置` 支持参数弹窗编辑并实时应用到图表。
  - 指标交互嵌入图表（2026-02-14）：
    - 指标操作入口从工具栏移入图表主画布左上角，按指标渲染自适应宽度的标签。
    - 默认状态仅展示“名称 + 参数 + 数值”，不显示背景框与操作按钮。
    - 鼠标悬停标签后显示背景框与 `隐藏/显示`、`设置`、`删除` 操作按钮，同时隐藏数值文本。
  - 原生指标区域对齐修正（2026-02-14）：
    - 移除自定义左上角指标覆盖层，避免与 `klinecharts` 原生指标 tooltip 重复渲染（如 MA 出现双份）。
    - 指标操作改为依托原生 tooltip 图标交互：在原生指标行内提供 `隐藏`、`设置`、`删除` 图标，点击通过 `ActionType.OnTooltipIconClick` 回调触发对应逻辑。
  - 本地化 `klinecharts` 源码接入（2026-02-14）：
    - 从 `E:\Study\KLineChart9.8.12` 的 `v9.8.12` 标签复制源码至 `Client/vendors/klinecharts_local`，并在项目内完成 `dist` 构建。
    - 构建解析改为优先本地库：`vite.config.ts` 增加 `klinecharts` 别名到 `./vendors/klinecharts_local/dist/index.esm.js`，`tsconfig.app.json` 增加 `paths` 到本地 `index.d.ts`。
    - 本地库扩展 hover 事件：`ActionType` 新增 `onIndicatorTooltipHover` 与 `onTooltipIconHover`，用于外部订阅指标行悬停与图标悬停。
    - 指标 tooltip 图标渲染逻辑调整：默认不显示，悬停到对应指标行时再显示，并保留 `onTooltipIconClick` 点击回调。
  - 指标 tooltip 悬停显示策略调整（2026-02-14）：
    - 悬停到某指标行时：隐藏该行数值，仅显示“指标名称 + 参数 + 操作图标（隐藏/设置/删除）”。
    - 未悬停时：显示“指标名称 + 参数 + 数值”，并为指标行增加背景框（悬停态背景加深）。
    - 该行为在主图与副图均按各自 pane 生效，互不串位。
  - 指标 tooltip 图标与背景细节调整（2026-02-14）：
    - 未悬停状态下，指标行背景改为完全透明。
    - 操作入口由单文字改为矢量图标（`svg:hide` / `svg:settings` / `svg:delete`），在本地化 `klinecharts` 源码内使用 canvas 路径绘制，继续复用原生 `OnTooltipIconClick` 事件链路。
  - `MarketChart` 绘图栏专业化重构（2026-02-14）：
    - 二级工具栏中的文字型“绘图按钮组”下线，改为主图左侧单列 `klinecharts-pro-drawing-bar`，布局对齐 `Client/src/components/MarketChart.DrawingBar.布局说明.md`。
    - 绘图栏实现 5 组绘图工具（线段/通道/形状/斐波那契/波浪）+ 分割线 + 磁吸/锁定/显示隐藏/清空控制，全部使用 SVG 图标显示。
    - 每组支持“主图标直接绘图 + 右侧箭头展开列表”，并支持列表向上/向下自适应展开、点击外部自动收起。
    - 绘图状态联动补齐：磁吸模式（弱/强+开关）、锁定、整体可见性对已创建 overlay 实时同步，清空时重置绘图追踪状态。
    - 图表区域结构调整为 `market-chart-body`（左侧绘图栏 + 右侧 `market-chart-stage`），与官方交互模型保持一致。
  - `MarketChart` 顶部工具栏整合（2026-02-14）：
    - 移除 `market-chart-info` 行以及旧的三段式 toolbar（基础工具栏 / 设置工具栏 / 指标工具栏）分拆布局。
    - 合并为单行工具栏：左侧保留币种选择与周期选择；右侧改为按钮序列 `指标 / 时区 / 设置 / 截图 / 全屏`。
    - `指标`、`时区`、`设置` 均改为点击弹出面板交互：支持外部点击自动收起。
    - `设置` 面板新增可切换项：`最新`、`高`、`低`、`指标最新值显示`、`网格线显示`，并支持在面板内切换蜡烛图类型与价格轴类型。
    - `最新/高/低` 同步控制顶部快速行情显示；`指标最新值显示` 与 `网格线显示` 同步下发到图表样式配置。

### 3.1.1 官方策略详情与运用
- 官方策略卡片右上角新增按钮：**详情与运用**
- 弹窗包含历史版本查看（复用 `StrategyHistoryDialog` 的 `strategy-history-body`）
- 底部按钮：**运用 v* 版本**（仅展示，暂不实现实际功能）

### 3.2 策略模块页签
- 新增 / 已有页签内容：
  - 推荐（整合官方策略 + 策略广场）
  - 官方策略
  - 策略广场
  - 策略模板
  - 创建策略

### 3.3 推荐模块
- 新组件 `StrategyRecommend`：
  - 分两块显示：官方策略 + 策略广场
  - 每块最多展示 4 条

### 3.4 策略广场列表
- 新组件 `StrategyMarketList` / `StrategyMarketItem`
  - 展示标题、作者、交易信息

### 3.5 侧边栏用户权限展示
- 左侧用户信息区域显示角色（普通用户/会员/达人/超级管理）

### 3.6 策略列表高亮
- StrategyItem 背景色提示：
  - 淡红色：官方策略
  - 淡蓝色：策略模板

## 4. 相关文件清单

### 后端
- `SeverTest/Modules/StrategyManagement/Controllers/StrategyController.cs`
- `SeverTest/Modules/Shared/Models/Strategy/StrategyRequests.cs`
- `SeverTest/Modules/Accounts/Controllers/AuthController.cs`

### 前端
- `Client/src/components/StrategyModule.tsx`
- `Client/src/components/StrategyDetailDialog.tsx`
- `Client/src/components/StrategyList.tsx`
- `Client/src/components/StrategyMarketList.tsx`
- `Client/src/components/StrategyMarketItem.tsx`
- `Client/src/components/StrategyMarketItem.css`
- `Client/src/components/StrategyRecommend.tsx`
- `Client/src/components/StrategyRecommend.css`
- `Client/src/components/OfficialStrategyItem.tsx` / `.css`
- `Client/src/components/StrategyTemplateItem.tsx` / `.css`
- `Client/src/components/OfficialStrategyList.tsx`
- `Client/src/components/TemplateStrategyList.tsx`
- `Client/src/components/StrategyCatalog.css`
- `Client/src/components/OfficialStrategyDetailDialog.tsx`
- `Client/src/components/OfficialStrategyDetailDialog.css`
- `Client/src/components/Dashboard.tsx`
- `Client/src/auth/profileStore.ts`
- `Client/src/components/SignIn4.tsx`

## 5. 角色约定
- `0`：普通用户
- `20`：会员
- `40`：达人
- `255`：超级管理（可发布官方/模板）
