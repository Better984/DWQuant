# 策略模块改动记录（官方策略 / 策略模板 / 策略广场 / 推荐）

## 1. 新增数据表（MySQL）

### 1.1 官方策略
- 表：`official_strategy_def`
  - `def_id` bigint unsigned PK AI：官方策略定义 ID
  - `creator_uid` bigint unsigned：创建者（官方维护者）
  - `source_us_id` bigint unsigned：来源用户策略实例（用于同步/移除）
  - `def_type` varchar(16)：固定为 `official`
  - `name` varchar(64)：名称
  - `description` varchar(255)：描述
  - `latest_version_id` bigint unsigned：最新版本
  - `created_at` datetime(3)
  - `updated_at` datetime(3)
  - 索引：`uk_source_us`(source_us_id) 防止同一实例重复发布
- 表：`official_strategy_version`
  - `version_id` bigint unsigned PK AI
  - `def_id` bigint unsigned：引用 `official_strategy_def`
  - `version_no` int：版本号
  - `content_hash` char(64)：配置哈希
  - `config_json` json：策略配置
  - `artifact_uri` varchar(512) 可空
  - `changelog` varchar(255)
  - `created_by` bigint unsigned
  - `created_at` datetime(3)

### 1.2 策略模板
- 表：`template_strategy_def`
  - `def_id` bigint unsigned PK AI：模板定义 ID
  - `creator_uid` bigint unsigned
  - `source_us_id` bigint unsigned：来源用户策略实例（用于同步/移除）
  - `def_type` varchar(16)：固定为 `template`
  - `name` varchar(64)
  - `description` varchar(255)
  - `latest_version_id` bigint unsigned
  - `created_at` datetime(3)
  - `updated_at` datetime(3)
  - 索引：`uk_source_us`(source_us_id) 防止同一实例重复发布
- 表：`template_strategy_version`
  - `version_id` bigint unsigned PK AI
  - `def_id` bigint unsigned：引用 `template_strategy_def`
  - `version_no` int
  - `content_hash` char(64)
  - `config_json` json
  - `artifact_uri` varchar(512) 可空
  - `changelog` varchar(255)
  - `created_by` bigint unsigned
  - `created_at` datetime(3)

### 1.3 策略广场
- 表：`strategy_market`
  - `market_id` bigint unsigned PK AI
  - `us_id` bigint unsigned：用户策略实例 ID
  - `uid` bigint unsigned：发布用户 ID
  - `def_id` bigint unsigned
  - `pinned_version_id` bigint unsigned
  - `title` varchar(64)
  - `description` varchar(255)
  - `created_at` datetime(3)
  - `updated_at` datetime(3)
  - 索引：`uk_us`(us_id) 防止重复公开

## 2. 新增/调整接口（后端）

### 2.1 官方策略 / 策略模板
- `GET /api/strategy/official/list`
  - 返回官方策略列表（含最新版本 config_json）
- `GET /api/strategy/official/versions?defId=`
  - 返回官方策略历史版本（用于详情查看/选择版本）
- `GET /api/strategy/template/list`
  - 返回策略模板列表（含最新版本 config_json）
- `POST /api/strategy/publish/official`
  - 超级管理发布自己的策略为官方策略
- `POST /api/strategy/publish/template`
  - 超级管理发布自己的策略为模板
- `POST /api/strategy/official/sync`
  - 超级管理一键同步最新版本到官方策略
- `POST /api/strategy/template/sync`
  - 超级管理一键同步最新版本到策略模板
- `POST /api/strategy/official/remove`
  - 超级管理将策略从官方策略库移除
- `POST /api/strategy/template/remove`
  - 超级管理将策略从模板库移除

> 权限：仅 `role=255` 允许发布/同步/移除官方策略与模板。

### 2.2 策略广场
- `GET /api/strategy/market/list`
  - 返回策略广场公开列表
- `POST /api/strategy/market/publish`
  - 用户公开自己的策略到广场
  - 同步更新 `user_strategy.visibility = 'public'`
- `POST /api/strategy/market/sync`
  - 用户一键同步最新版本到策略广场

### 2.3 登录返回 role
- `POST /api/auth/login`
  - 返回 `role`（前端用于展示权限与超级管理入口）

## 3. 前端功能变更

### 3.1 策略详情页（StrategyDetailDialog）
- 新增按钮：
  - **公开到策略广场**（所有用户）
  - **发布为官方策略 / 发布为策略模板**（仅超级管理）
  - **发布最新版本到官方/模板/广场**
  - **从官方策略中移除 / 从策略模板中移除**（仅超级管理）
- 所有发布/同步/移除动作均有确认弹窗
- 新增页签：**回测**，支持填写回测参数并调用 `backtest.run` 展示回测结果

### 3.1.1 官方策略详情与运用
- 官方策略卡片右上角新增按钮：**详情与运用**
- 弹窗包含历史版本查看（复用 `StrategyHistoryDialog` 的 `strategy-history-body`）
- 底部按钮：**运用 v* 版本**（仅展示，暂不实现实际功能）

### 3.2 策略模块页签
- 新增 / 已有页签内容：
  - 推荐（整合官方策略 + 策略广场）
  - 官方策略
  - 策略广场
  - 策略模板
  - 创建策略

### 3.3 推荐模块
- 新组件 `StrategyRecommend`：
  - 分两块显示：官方策略 + 策略广场
  - 每块最多展示 4 条

### 3.4 策略广场列表
- 新组件 `StrategyMarketList` / `StrategyMarketItem`
  - 展示标题、作者、交易信息

### 3.5 侧边栏用户权限展示
- 左侧用户信息区域显示角色（普通用户/会员/达人/超级管理）

### 3.6 策略列表高亮
- StrategyItem 背景色提示：
  - 淡红色：官方策略
  - 淡蓝色：策略模板

## 4. 相关文件清单

### 后端
- `SeverTest/Modules/StrategyManagement/Controllers/StrategyController.cs`
- `SeverTest/Modules/Shared/Models/Strategy/StrategyRequests.cs`
- `SeverTest/Modules/Accounts/Controllers/AuthController.cs`

### 前端
- `Client/src/components/StrategyModule.tsx`
- `Client/src/components/StrategyDetailDialog.tsx`
- `Client/src/components/StrategyList.tsx`
- `Client/src/components/StrategyMarketList.tsx`
- `Client/src/components/StrategyMarketItem.tsx`
- `Client/src/components/StrategyMarketItem.css`
- `Client/src/components/StrategyRecommend.tsx`
- `Client/src/components/StrategyRecommend.css`
- `Client/src/components/OfficialStrategyItem.tsx` / `.css`
- `Client/src/components/StrategyTemplateItem.tsx` / `.css`
- `Client/src/components/OfficialStrategyList.tsx`
- `Client/src/components/TemplateStrategyList.tsx`
- `Client/src/components/StrategyCatalog.css`
- `Client/src/components/OfficialStrategyDetailDialog.tsx`
- `Client/src/components/OfficialStrategyDetailDialog.css`
- `Client/src/components/Dashboard.tsx`
- `Client/src/auth/profileStore.ts`
- `Client/src/components/SignIn4.tsx`

## 5. 角色约定
- `0`：普通用户
- `20`：会员
- `40`：达人
- `255`：超级管理（可发布官方/模板）

