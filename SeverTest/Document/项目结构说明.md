# 项目结构说明

本文档简要说明服务器端各目录的主要作用，便于快速定位功能与代码范围。

## 根目录（SeverTest）
- `APP_Build/`：发布打包目录，包含一键打包脚本 `build_server.bat`（执行 `dotnet publish` 并生成 zip 产物；产物按 `v0001` 递增目录保存，最多保留 5 个历史版本）。
- `Modules/`：按业务模块拆分的主代码目录（见下方模块说明）。
- `Config/`：策略与功能配置文件（含 `server-role.local.json` 启动角色记忆文件）。
- `Document/`：项目文档与使用说明（含 `Protocol/` 协议文档）。
- `Properties/`：项目与构建相关的属性配置。
- `Startup/`：系统启动流程与中间件管道编排。
- `appsettings.json` / `appsettings.Development.json`：运行配置与环境配置。
- `Program.cs`：应用入口与依赖注入/中间件注册。
- `ServerTest.csproj` / `ServerTest.sln`：项目与解决方案文件。
- `PRICE_SUBSCRIPTION_README.md` / `README.md`：专项说明与总览文档。
- `bin/`、`obj/`：编译输出与中间文件。

## Modules 目录结构约定
- `Application/`：应用层服务、用例编排、业务流程入口。
- `Infrastructure/`：数据访问、第三方集成、外部系统适配。
- `Domain/`：领域模型与核心业务对象。
- `Sql/`：模块相关 SQL 片段或说明（如有）。
- `功能说明.md`：模块功能概述与联动关系说明。

## Modules 列表与职责
- `Accounts/`：账户鉴权、用户登录与交易设置。
- `AdminBroadcast/`：管理员广播与全局消息推送。
- `Backtest/`：回测服务与历史行情驱动执行；支持同步/异步与分布式算力两种执行架构，含任务队列、并发限流与持久化。
- `ExchangeApiKeys/`：交易所 API Key 管理。
- `MarketData/`：历史行情与行情维护。
- `MarketStreaming/`：行情订阅、WebSocket 行情推送与价格流。
- `Monitoring/`：系统启动监控与运行状态记录。
- `Notifications/`：通知渠道与用户通知偏好。
- `Positions/`：仓位与风控相关逻辑（含仓位总览聚合查询：开仓历史、版本参与、当前持仓与浮动盈亏；近期总结聚合：1/3/7/30 天回退窗口、胜率、已实现盈亏、当前浮动盈亏；近期操作日志：开仓/平仓与告警时间线）。
- `Shared/`：通用基础设施、公共模型、通用中间件与服务器配置中心。
- `StrategyEngine/`：策略核心执行与运行日志。
- `StrategyManagement/`：策略管理（增删改查、配置管理等）。
- `StrategyRuntime/`：策略运行时状态与调度。
- `TradingExecution/`：交易执行与下单流程。
- `WebSockets/`：WebSocket 基础设施与消息处理。

## 关键运行机制说明
- 启动流程：`Startup/SystemStartupWorkflow.cs` 负责启动步骤编排，`Startup/SystemPipeline.cs` 负责中间件管道配置。
- 服务器角色启动：`Shared/Application/Services/ServerRoleBootstrap.cs` 在启动时支持三步交互（选择角色→是否更新分布式核心节点地址→确认启动），并持久化到 `Config/server-role.local.json`。
- WebSocket 跨节点挤线：`Program.cs` 在 `KickOld` 策略下会先广播分布式踢线，再进行本地挤出，提升多节点连接一致性。
- 账户同类型单会话：`Accounts/AuthController` 登录支持 `system` 维度会话互斥；同一用户在同一 `system`（如 web/pc/game）新登录时，会废止旧 token 并触发分布式踢线。
- HTTP Token 统一校验：`Shared/Middleware/HttpTokenValidationMiddleware` 对所有携带 Bearer Token 的 HTTP 请求做前置校验；当旧会话被替换后，原 token 的 HTTP 请求会统一返回鉴权失败（401/2001）。
- 策略多实例租约：`StrategyRuntime/StrategyOwnershipService` + `StrategyRuntimeLeaseHostedService` 通过 Redis 租约保证策略单实例执行，并支持接管与同步。
- 运行配置新增：`appsettings.json` 中新增 `Startup`（启动超时/预热）与 `StrategyOwnership`（租约/同步）配置项。
- 队列配置校验：`RuntimeQueue` 启动即校验容量与策略，避免误配置导致无界队列。
- 条件缓存清理：`StrategyEngine/ConditionCacheCleanupHostedService` 定期清理无引用缓存，配置项为 `ConditionCache`。
- 服务器配置中心：`Shared/Infrastructure/Config` 从数据库加载可控参数，后台管理可更新并标注实时性。
- 回测任务队列：`Backtest/BacktestTaskWorker`（HostedService）后台处理异步回测任务，受 `Backtest:MaxConcurrentTasks` 等配置限流，任务持久化到 `backtest_task` 表。
- 分布式回测算力：核心节点通过 `Backtest/BacktestWorkerGateway` 接收算力节点连接，经 `BacktestWorkerDispatchHostedService` 分发任务，算力节点通过 `BacktestWorkerClientHostedService` 回传进度与结果。
- 分布式回测执行保护：算力节点执行遵循 `Backtest:TaskTimeoutMinutes` 超时限制；任务结果写回仅在 `running` 状态生效，降低取消/重排队后的状态覆盖风险。
- 分布式回测 DI 约束：`BacktestWorkerMessageService` 与 `BacktestTaskRepository` 需保持同一作用域生命周期（`Scoped`），避免单例消费作用域仓储导致启动失败。
- 分布式回测 DI 约束：`BacktestWorkerDispatchHostedService` 为单例后台服务，需在运行中创建作用域获取 `BacktestTaskRepository`，禁止构造函数直接注入作用域仓储。
- 回测执行职责拆分：`Backtest/BacktestRunner` 负责流程编排与数据聚合，`Backtest/BacktestMainLoop` 负责执行与收尾；支持 `batch_open_close`（批量开仓 + 并行平仓）与 `timeline`（时间轴串行）两种模式，可通过服务器配置实时切换默认模式。
- 回测对象池预热：`Backtest/BacktestObjectPoolWarmupHostedService` 在启动阶段初始化热点对象池，主循环和条件评估复用池对象，减少高频内存分配。
- 通知投递 DI 约束：`NotificationDeliveryWorker` 依赖 `INotificationTemplateRenderer` 与 `INotificationSender` 集合，需在 `Program.cs` 显式注册渲染器与各渠道 Sender。
- WebSocket 预校验：`Controllers/WsHandshakeController.cs` 提供 `/api/ws/handshake/check` 接口，在前端真正发起 `/ws` 握手前统一校验 token 等基础条件，并以协议格式返回失败原因，便于通用弹窗展示。

## 前端补充说明（Client）
- **命名与资源**：基础 UI 组件 CSS 类前缀统一为 `ui-`（如 `ui-dialog`、`ui-button`）；静态图标与资源位于 `Client/src/assets/icons/`（子目录：`crypto`、`cex`、`country`、`head`、`icon`）。UI 组件测试页路由为 `/ui-test`。
- `Client/src/components/layout/Dashboard.tsx`：Dashboard 主内容模块改为懒加载（`React.lazy + Suspense`），降低首屏解析与执行开销；右侧栏拖拽宽度改为按帧更新，减少拖拽卡顿。
- `Client/src/network/marketStream.ts`：行情 WS 推送改为“同帧同 symbol 合并后再分发”，降低高频行情导致的前端渲染抖动。
- `Client/src/components/IndicatorModule.tsx`：指标中心已改为组件化指标卡片，并接入 ECharts 图表渲染（当前使用本地静态示例数据）。
- `Client/src/components/IndicatorModule.css`：新增指标中心样式文件，提供卡片布局、图表容器样式及移动端响应式适配。
- `Client/src/components/HomeModule.css`：首页卡片布局已优化为响应式自适应网格，修复窄屏场景下卡片同排等高导致的空白过大问题；“近期总结/系统公告”固定整行，“快捷入口”按钮按宽度自动换列，提升信息密度与可读性；首页仓位事件等使用 `assets/icons/crypto` 的币种 SVG。
- `Client/vendors/klinecharts_local/`：本地化 `klinecharts` 源码目录（含魔改能力）；`dist` 与 `node_modules` 不入库，需要本机构建。
- `Client/scripts/ensure-local-klinecharts.mjs`：本地 `klinecharts` 同步兜底脚本；`npm run dev`/`npm run build` 会先检查 `dist`，缺失时自动安装依赖并构建，避免 `Failed to resolve import "klinecharts"`。
- 指标覆盖范围：贪婪恐慌指数、ETF 净流入、交易所净流入/流出、多空持仓比、资金费率、未平仓合约、强平金额、稳定币净流入与流通市值。
