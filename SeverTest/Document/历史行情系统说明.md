# 历史行情系统说明

## 概述

本系统用于历史行情（K 线）数据的同步、缓存与查询。核心目标是：
- 服务器启动后自动同步并预热历史行情缓存
- 支持多交易所 / 多币对 / 多周期的数据管理
- 提供精简对外接口，供业务快速获取历史数据

## 核心能力

1) 启动同步与预热
- 应用启动后自动执行历史数据同步（可关闭）
- 同步结束后按配置起始时间预热缓存（可关闭）

2) 定期同步
- 按配置时间间隔定期执行增量补齐（HistoricalData:SyncIntervalMinutes）

3) 数据同步（增量）
- 逐表检查是否存在
- 读取数据库最后一根 K 线时间，按周期做增量补齐
- 使用 `INSERT IGNORE` 避免重复写入

4) 历史缓存
- 缓存按 `交易所 + 币对 + 周期` 进行分组
- 支持按时间范围读取并回填缓存
- 支持缓存快照供监控界面展示

## 主要组件

### 1. HistoricalMarketDataSyncHostedService
**位置**：`SeverTest/Modules/MarketData/Application/HistoricalMarketDataSyncHostedService.cs`  
**作用**：启动时执行历史行情同步与预热流程，并按配置周期执行增量同步。

启动流程：
1. 判断是否启用同步（`HistoricalData:SyncEnabled`）
2. 同步完成后判断是否启用预热（`HistoricalData:PreloadEnabled`）
3. 使用 `HistoricalData:PreloadStartDate` 作为预热起始时间

### 2. HistoricalMarketDataSyncService
**位置**：`SeverTest/Modules/MarketData/Application/HistoricalMarketDataSyncService.cs`  
**作用**：负责增量同步历史行情到数据库。

核心流程：
- `SyncIfNeededAsync`：按交易所 / 币对 / 周期并发同步
- `SyncSingleAsync`：检查表结构 → 获取最后时间 → 拉取补齐 → 写库

### 3. HistoricalMarketDataRepository
**浣嶇疆**锛歚SeverTest/Modules/MarketData/Infrastructure/HistoricalMarketDataRepository.cs`  
**浣滅敤**锛氶泦涓鐞嗗巻鍙茶鎯呰〃鐨勬煡璇㈠拰鍐欏叆锛堣〃瀛樺湪妫€鏌ャ€佹渶鍚庢椂闂存煡璇㈠拰鎵归噺鍐欏叆锛夛紝淇濊瘉 SQL 浠呭嚭鐜板湪浠撳偍灞?

### 4. HistoricalMarketDataCache
**位置**：`SeverTest/Modules/MarketData/Application/HistoricalMarketDataCache.cs`  
**作用**：历史数据缓存与按需回表查询。

核心方法：
- `GetHistoryAsync`：获取历史行情（优先缓存，未命中回表）
- `WarmUpCacheAsync`：启动预热缓存
- `GetCacheSnapshots`：输出缓存快照，供监控界面展示

## 对外接口

### 1) 获取最新 K 线
**API**：`GET /api/MarketData/latest`  
**位置**：`SeverTest/Modules/MarketData/Controllers/MarketDataController.cs`  
**说明**：从实时行情引擎返回最新 1 根 K 线（非历史系统）。

### 2) 获取历史 K 线（历史缓存系统）
**API**：`GET /api/MarketData/history`  
**位置**：`SeverTest/Modules/MarketData/Controllers/MarketDataController.cs`  
**说明**：使用历史缓存服务读取数据，必要时回表。

参数：
- `exchange` 交易所枚举
- `symbol` 币对枚举
- `timeframe` 周期枚举
- `startTime` 起始时间（可选）
- `endTime` 结束时间（可选）
- `count` 返回条数

## 启动时的行为

1. **同步历史行情**  
由 `HistoricalMarketDataSyncHostedService.ExecuteAsync` 触发  
执行：检查表结构、增量同步到数据库

2. **预热历史缓存**  
由 `HistoricalMarketDataSyncHostedService.ExecuteAsync` 触发  
执行：从 `PreloadStartDate` 起始时间读取历史数据并缓存

3. **定期增量同步**  
由 `HistoricalMarketDataSyncHostedService.ExecuteAsync` 持续运行  
执行：按 `SyncIntervalMinutes` 周期触发增量同步

## 配置项

配置文件位置：`SeverTest/appsettings.json`

```json
"HistoricalData": {
  "SyncEnabled": true,
  "PreloadEnabled": true,
  "PreloadStartDate": "2025-01-01",
  "SyncBatchSize": 1000,
  "SyncMaxParallel": 3,
  "SyncMinGapMinutes": 2,
  "SyncIntervalMinutes": 60,
  "DefaultStartDate": "2025-01-01",
  "MaxQueryBars": 2000,
  "MaxCacheBars": 0
}
```

说明：
- `PreloadStartDate`：预热起始日期
- `SyncIntervalMinutes`：定期同步执行间隔（分钟）
- `MaxCacheBars`：缓存上限，`0` 表示不限制
- `MaxQueryBars`：接口返回上限（不影响预热）

## 缓存结构

缓存键：
- `exchange:symbol:timeframe`

缓存内容：
- `List<OHLCV>` 按时间升序排列

## 监控界面

启动监控界面“历史行情”页会展示：
- 交易所 / 币对 / 周期
- 缓存起止时间
- 缓存条数

位置：`SeverTest/Modules/Monitoring/Application/StartupMonitorForm.cs`

## 注意事项

- 如果历史表不存在，会跳过同步并输出日志
- 预热读取大量数据，启动时间会变长
- `MaxCacheBars = 0` 表示不限制缓存数量（注意内存占用）
