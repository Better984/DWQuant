<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>策略模块接口文档（含分享链/版本/状态）</title>
  <style>
    body { font-family: Arial, "Microsoft YaHei", sans-serif; line-height: 1.55; padding: 18px; }
    h1 { margin-top: 0; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }
    code { font-family: Consolas, Menlo, monospace; }
    .note { color: #444; margin: 6px 0 14px; }
  </style>
</head>
<body>
  <h1>策略模块接口文档（含分享链 / 版本控制 / 运行状态）</h1>

  <p class="note">
    统一响应结构（除特殊说明外）：<br/>
    <code>{"status":"success|error","message":"xxx","data":{...}}</code><br/>
    统一鉴权：<code>Authorization: Bearer &lt;JWT&gt;</code>（导入分享码接口也建议需要登录）
  </p>

  <h2>1. 创建策略（自定义创建）</h2>
  <pre>
POST /api/strategy/create

请求：
{
  "name": "我的交易策略(定义名/源头名)",
  "description": "策略说明（模板/源策略展示用）",
  "aliasName": "BTC 1m 趋势策略（我的实例名）",
  "configJson": {
    "trade": { "exchange": "Bitget", "symbol": "BTC/USDT", "timeframeSec": 60 },
    "risk": { "stopLossPct": 0.008 }
  }
}

响应：
{
  "status": "success",
  "message": "创建成功",
  "data": {
    "defId": 30021,
    "usId": 9001001,
    "versionId": 71001,
    "versionNo": 1
  }
}

后端要做什么（核心）：
- 新建 strategy_def（def_type=custom, creator_uid=当前用户）
- 新建 strategy_version（v1, config_json, content_hash）
- 新建 user_strategy（实例：state=draft, pinned_version_id=v1）
  </pre>

  <h2>2. 修改策略（保存修改，Copy-on-Write 生成新版本）</h2>
  <pre>
POST /api/strategy/update

请求：
{
  "usId": 9001001,
  "configJson": {
    "trade": { "exchange": "Bitget", "symbol": "BTC/USDT", "timeframeSec": 60 },
    "risk": { "stopLossPct": 0.006 }
  },
  "changelog": "调整止损参数"
}

响应：
{
  "status": "success",
  "message": "修改成功（已生成新版本）",
  "data": {
    "usId": 9001001,
    "newVersionId": 71002,
    "newVersionNo": 2
  }
}

后端要做什么（核心）：
- 校验 usId 属于当前用户
- 在该 def_id 下新增 strategy_version（version_no + 1）
- 更新 user_strategy.pinned_version_id = newVersionId
说明：
- 这样模板/分享策略多人复用时，不会复制所有内容，只在“修改”时产生新版本（Copy-on-Write）
  </pre>

  <h2>3. 发布新版本（显式切换当前版本 + 可选改变状态）</h2>
  <pre>
POST /api/strategy/publish

请求：
{
  "usId": 9001001,
  "versionId": 71002,
  "stateAfterPublish": "ready",
  "changelog": "发布 v2"
}

响应：
{
  "status": "success",
  "message": "发布成功",
  "data": {
    "usId": 9001001,
    "pinnedVersionId": 71002,
    "state": "ready"
  }
}

后端要做什么（核心）：
- 校验 versionId 属于该 user_strategy.def_id
- 更新 user_strategy.pinned_version_id = versionId
- 可选：更新 user_strategy.state = stateAfterPublish
- 可选：若当前用户是 strategy_def.creator_uid 且 def_type=template，可同步 strategy_def.latest_version_id
  </pre>

  <h2>4. 修改运行状态（运行 / 暂停 / 归档）</h2>
  <pre>
POST /api/strategy/set-state

请求：
{
  "usId": 9001001,
  "state": "running"   // draft/ready/running/paused/archived
}

响应：
{
  "status": "success",
  "message": "状态修改成功",
  "data": {
    "usId": 9001001,
    "state": "running"
  }
}

后端要做什么（核心）：
- UPDATE user_strategy.state
说明：
- 状态属于“用户实例”，不会影响模板/源策略本体
  </pre>

  <h2>5. 获取完整分享链（溯源链路）</h2>
  <pre>
GET /api/strategy/share-chain?usId=9001001

响应（示例）：
{
  "status": "success",
  "message": "获取成功",
  "data": {
    "usId": 9001001,
    "source": { "type": "share_code", "ref": "importLog:551233" },
    "chain": [
      { "step": 1, "type": "share_code", "shareCode": "S7K9Q2", "importerUid": 10004, "importAt": "2026-01-19T10:12:34.123+08:00" },
      { "step": 2, "type": "template", "templateDefId": 30021 }
    ]
  }
}

后端要做什么（核心）：
- 约定：user_strategy.source_ref 推荐存 strategy_import_log.id（这样链路完整且可审计）
- 递归/循环查询 import_log：import_log.source_ref => (shareCode/templateDefId) 直到 custom/空
  </pre>

  <h2>6. 创建分享码（让别人通过短码导入）</h2>
  <pre>
POST /api/strategy/share/create-code

请求：
{
  "usId": 9001001
}

响应：
{
  "status": "success",
  "message": "分享码生成成功",
  "data": {
    "usId": 9001001,
    "visibility": "shared",
    "shareCode": "S7K9Q2"
  }
}

后端要做什么（核心）：
- 生成短码（6~10位，保证唯一）
- UPDATE user_strategy.visibility='shared', share_code='S7K9Q2'
  </pre>

  <h2>7. 通过分享码导入为自己的策略（保留分享线路）</h2>
  <pre>
POST /api/strategy/import/share-code

请求：
{
  "shareCode": "S7K9Q2",
  "aliasName": "我导入的策略（副本）"
}

响应：
{
  "status": "success",
  "message": "导入成功",
  "data": {
    "newUsId": 9002002,
    "defId": 30021,
    "pinnedVersionId": 71002,
    "sourceType": "share_code",
    "importLogId": 551233
  }
}

后端要做什么（必须事务）：
- 通过 shareCode 找源 user_strategy（拿 def_id + pinned_version_id）
- INSERT user_strategy（归属当前用户；pinned_version_id 复用源版本）
- INSERT strategy_import_log（source_type='share_code', source_ref=shareCode）
- UPDATE user_strategy.source_ref = importLogId（形成完整链）
  </pre>

  <h2>8. 溯源：通过用户ID查看“我分享的策略被谁使用了”</h2>
  <pre>
GET /api/strategy/share/usage?ownerUid=10004&page=1&pageSize=20

响应：
{
  "status": "success",
  "message": "获取成功",
  "data": {
    "page": 1,
    "pageSize": 20,
    "items": [
      {
        "shareCode": "S7K9Q2",
        "sourceOwnerUid": 10004,
        "importerUid": 20008,
        "importerUsId": 9002002,
        "importAt": "2026-01-19T10:12:34.123+08:00"
      }
    ]
  }
}

后端要做什么（核心）：
- 先查 ownerUid 的 share_code 列表（user_strategy.share_code）
- 再查 strategy_import_log 里 source_type='share_code' 且 source_ref in (share_codes)
- 返回导入者 uid、导入生成的 us_id、导入时间
  </pre>

  <h1>数据库表结构（最新DDL，可直接复制执行）</h1>
  <h2>A. strategy_def（策略定义：模板/公共源头）</h2>
  <pre>
CREATE TABLE `strategy_def` (
  `def_id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '策略定义ID(PK)。模板/公共策略/源策略的“根实体”',
  `creator_uid` BIGINT UNSIGNED NOT NULL COMMENT '创建者用户ID(作者)。用于溯源与展示作者信息',
  `def_type` VARCHAR(16) NOT NULL COMMENT '定义类型：template=公共模板，custom=自定义源头，public_sale=可售卖源头',

  `name` VARCHAR(64) NOT NULL COMMENT '策略定义名称(模板名/源策略名)。用户实例可另起 alias_name',
  `description` VARCHAR(255) NOT NULL DEFAULT '' COMMENT '策略定义描述(模板/市场展示用)',

  `latest_version_id` BIGINT UNSIGNED NULL COMMENT '最新版本ID(指向strategy_version.version_id)，用于快速获取最新版本',

  `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '创建时间',
  `updated_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3) COMMENT '更新时间',

  PRIMARY KEY (`def_id`),
  KEY `idx_creator_updated` (`creator_uid`, `updated_at`),
  KEY `idx_type_updated` (`def_type`, `updated_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='策略定义(模板/公共源头)。内容本体在strategy_version里，用户运行实例在user_strategy里';
  </pre>

  <h2>B. strategy_version（策略版本：内容本体，支持复用）</h2>
  <pre>
CREATE TABLE `strategy_version` (
  `version_id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '版本ID(PK)',
  `def_id` BIGINT UNSIGNED NOT NULL COMMENT '所属策略定义ID(strategy_def.def_id)。1个def对应多个版本',

  `version_no` INT NOT NULL COMMENT '版本号(1,2,3...)。用于版本控制与回滚',
  `content_hash` CHAR(64) NOT NULL COMMENT '内容哈希(建议sha256)，用于ETag缓存/判重/一致性校验',

  `config_json` JSON NOT NULL COMMENT '策略配置JSON(核心内容)：trade/risk/logic等整坨内容',
  `artifact_uri` VARCHAR(512) NULL COMMENT '可选：策略代码/产物引用(对象存储路径或git ref)',

  `changelog` VARCHAR(255) NOT NULL DEFAULT '' COMMENT '版本变更说明(发布日志)',
  `created_by` BIGINT UNSIGNED NOT NULL COMMENT '创建该版本的用户ID(作者或导入后修改者)',
  `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '版本创建时间',

  PRIMARY KEY (`version_id`),
  UNIQUE KEY `uk_def_versionno` (`def_id`, `version_no`),
  KEY `idx_def_created` (`def_id`, `created_at`),
  KEY `idx_hash` (`content_hash`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='策略版本(内容本体)。Copy-on-Write：多人共享同一版本，修改才产生新版本';
  </pre>

  <h2>C. user_strategy（用户策略实例：状态/分享/当前版本指针）</h2>
  <pre>
CREATE TABLE `user_strategy` (
  `us_id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户策略实例ID(PK)。用户真正运行/管理的是它',
  `uid` BIGINT UNSIGNED NOT NULL COMMENT '归属用户ID：谁拥有该实例(可见/可运行)',

  `def_id` BIGINT UNSIGNED NOT NULL COMMENT '引用的策略定义(strategy_def.def_id)。模板/源策略根实体',
  `pinned_version_id` BIGINT UNSIGNED NOT NULL COMMENT '当前使用版本(strategy_version.version_id)。运行/编辑默认基于此版本',

  `alias_name` VARCHAR(64) NOT NULL DEFAULT '' COMMENT '用户自定义名称(实例名)。不影响模板/源策略',
  `description` VARCHAR(255) NOT NULL DEFAULT '' COMMENT '用户自定义描述(可选)',

  `state` VARCHAR(16) NOT NULL COMMENT '实例状态：draft/ready/running/paused/archived。属于用户实例，不影响模板',
  `visibility` VARCHAR(16) NOT NULL DEFAULT 'private' COMMENT '分享/可见性：private/shared/public_sale',
  `share_code` VARCHAR(32) NULL COMMENT '分享短码(可空)。用于他人导入。建议唯一',
  `price_usdt` DECIMAL(18,8) NOT NULL DEFAULT 0 COMMENT '售卖价格USDT(visibility=public_sale时使用)，否则可为0',

  `source_type` VARCHAR(16) NOT NULL COMMENT '来源类型：custom/template/share_code。表示该实例从哪获得',
  `source_ref` VARCHAR(64) NULL COMMENT '来源引用：建议存 import_log.id（可形成完整溯源链），也可存 template_def_id/share_code',

  `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '实例创建时间(导入/创建时)',
  `updated_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3) COMMENT '实例更新时间(改名/切版本/状态变更等)',

  PRIMARY KEY (`us_id`),
  KEY `idx_uid_updated` (`uid`, `updated_at`),
  KEY `idx_uid_state` (`uid`, `state`),
  UNIQUE KEY `uk_share_code` (`share_code`),
  KEY `idx_def_version` (`def_id`, `pinned_version_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户策略实例(状态/分享/售卖/当前版本指针)。模板多人使用只会新增实例行，不复制版本内容';
  </pre>

  <h2>D. strategy_import_log（导入日志：完整来源链审计）</h2>
  <pre>
CREATE TABLE `strategy_import_log` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '导入日志ID(PK)',
  `uid` BIGINT UNSIGNED NOT NULL COMMENT '导入者用户ID',
  `us_id` BIGINT UNSIGNED NOT NULL COMMENT '导入后生成的用户策略实例ID(user_strategy.us_id)',

  `source_type` VARCHAR(16) NOT NULL COMMENT '来源类型：template/share_code',
  `source_ref` VARCHAR(64) NOT NULL COMMENT '来源引用：template_def_id 或 share_code',

  `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '导入时间',

  PRIMARY KEY (`id`),
  KEY `idx_uid_time` (`uid`, `created_at`),
  KEY `idx_usid` (`us_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='策略导入事件审计表。用于完整分享链/溯源：谁在什么时候从哪里导入了哪个实例';
  </pre>

  <h1>多表联查（常用SQL示例）</h1>
  <h2>1) 用户策略列表（轻量，不返回大 config_json）</h2>
  <pre>
SELECT
  us.us_id, us.alias_name, us.state, us.visibility, us.share_code, us.price_usdt, us.updated_at,
  sd.def_id, sd.name AS def_name, sd.def_type,
  sv.version_id, sv.version_no, sv.content_hash
FROM user_strategy us
JOIN strategy_def sd ON sd.def_id = us.def_id
JOIN strategy_version sv ON sv.version_id = us.pinned_version_id
WHERE us.uid = ?
ORDER BY us.updated_at DESC
LIMIT 50;
  </pre>

  <h2>2) 用户策略详情（包含 config_json）</h2>
  <pre>
SELECT
  us.*,
  sd.name AS def_name, sd.def_type,
  sv.version_no, sv.content_hash, sv.config_json, sv.artifact_uri
FROM user_strategy us
JOIN strategy_def sd ON sd.def_id = us.def_id
JOIN strategy_version sv ON sv.version_id = us.pinned_version_id
WHERE us.us_id = ? AND us.uid = ?
LIMIT 1;
  </pre>

  <h1>新的策略JSON示范（详情页返回）</h1>
  <pre>{
    "userStrategy": {
      "usId": 12345,
      "uid": 10004,
      "uidCode": "min4sf73v7zz8ol79i",
  
      "defId": 30021,
      "aliasName": "我的交易策略",
      "description": "",
  
      "state": "running",
  
      "visibility": {
        "mode": "private",
        "isPublic": false,
        "priceUsdt": 0,
        "shareCode": null
      },
  
      "source": {
        "type": "custom",
        "sourceId": null,
        "sourceCreatorUserId": null,
        "note": null,
        "ref": null
      },
  
      "preposeUidCodes": [],
      "tags": [],
  
      "pinnedVersionId": 71001,
  
      "timestamps": {
        "createdAt": "2026-01-11T00:00:00Z",
        "updatedAt": "2026-01-11T00:00:00Z",
        "deletedAt": null
      }
    },
  
    "definition": {
      "defId": 30021,
      "defType": "custom",
      "creatorUid": 10004,
      "name": "我的交易策略",
      "description": ""
    },
  
    "version": {
      "versionId": 71001,
      "versionNo": 1,
      "contentHash": "sha256_of_strategyConfig_here",
      "artifactUri": null,
      "changelog": "",
  
      "configJson": {
        "trade": {
          "exchange": "Bitget",
          "symbol": "BTC/USDT",
          "timeframeSec": 60,
  
          "positionMode": "LongShort",
          "openConflictPolicy": "GiveUp",
  
          "sizing": {
            "orderQty": 0.001,
            "maxPositionQty": 10,
            "leverage": 100
          },
  
          "risk": {
            "takeProfitPct": 100,
            "stopLossPct": 50,
            "trailing": {
              "enabled": true,
              "activationProfitPct": 50,
              "closeOnDrawdownPct": 10
            }
          }
        },
  
        "logic": {
          "entry": {
            "long": {
              "containers": [
                {
                  "checks": {
                    "enabled": true,
                    "minPassGroups": 1,
                    "groups": [
                      {
                        "enabled": true,
                        "minPassConditions": 1,
                        "conditions": [
                          {
                            "enabled": true,
                            "required": false,
                            "method": "GreaterThanOrEqual",
                            "args": [
                              {
                                "refType": "Field",
                                "timeframe": "m1",
                                "input": "Close",
                                "params": [],
                                "output": "Value",
                                "offsetRange": [1, 1],
                                "calcMode": "OnBarClose"
                              },
                              {
                                "refType": "Indicator",
                                "indicator": "MA",
                                "timeframe": "m1",
                                "input": "HL2",
                                "params": [20],
                                "output": "Value",
                                "offsetRange": [1, 1],
                                "calcMode": "OnBarClose"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                }
              ],
              "enabled": true,
              "minPassConditionContainer": 1,
              "onPass": {
                "enabled": true,
                "minPassConditions": 1,
                "conditions": [
                  {
                    "enabled": true,
                    "required": false,
                    "method": "MakeTrade",
                    "args": ["Long"]
                  }
                ]
              }
            },
  
            "short": {
              "containers": [
                {
                  "checks": {
                    "enabled": true,
                    "minPassGroups": 1,
                    "groups": []
                  }
                }
              ],
              "enabled": true,
              "minPassConditionContainer": 1,
              "onPass": {
                "enabled": true,
                "minPassConditions": 1,
                "conditions": [
                  {
                    "enabled": true,
                    "required": false,
                    "method": "MakeTrade",
                    "args": ["Short"]
                  }
                ]
              }
            }
          },
  
          "exit": {
            "long": {
              "containers": [
                {
                  "checks": {
                    "enabled": true,
                    "minPassGroups": 1,
                    "groups": [
                      {
                        "enabled": true,
                        "minPassConditions": 1,
                        "conditions": [
                          {
                            "enabled": true,
                            "required": false,
                            "method": "GreaterThanOrEqual",
                            "args": [
                              {
                                "refType": "Indicator",
                                "indicator": "MA",
                                "timeframe": "m1",
                                "input": "HL2",
                                "params": [50],
                                "output": "Value",
                                "offsetRange": [0, 0],
                                "calcMode": "OnBarUpdate"
                              },
                              {
                                "refType": "Field",
                                "timeframe": "m1",
                                "input": "Close",
                                "params": [],
                                "output": "Value",
                                "offsetRange": [0, 0],
                                "calcMode": "OnBarUpdate"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                }
              ],
              "enabled": true,
              "minPassConditionContainer": 1,
              "onPass": {
                "enabled": true,
                "minPassConditions": 1,
                "conditions": [
                  {
                    "enabled": true,
                    "required": false,
                    "method": "MakeTrade",
                    "args": ["CloseLong"]
                  }
                ]
              }
            },
  
            "short": {
              "containers": [
                {
                  "checks": {
                    "enabled": true,
                    "minPassGroups": 1,
                    "groups": [
                      {
                        "enabled": true,
                        "minPassConditions": 1,
                        "conditions": [
                          {
                            "enabled": true,
                            "required": false,
                            "method": "LessThanOrEqual",
                            "args": [
                              {
                                "refType": "Indicator",
                                "indicator": "MA",
                                "timeframe": "m1",
                                "input": "HL2",
                                "params": [50],
                                "output": "Value",
                                "offsetRange": [1, 1],
                                "calcMode": "OnBarClose"
                              },
                              {
                                "refType": "Field",
                                "timeframe": "m1",
                                "input": "Close",
                                "params": [],
                                "output": "Value",
                                "offsetRange": [1, 1],
                                "calcMode": "OnBarClose"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                }
              ],
              "enabled": true,
              "minPassConditionContainer": 1,
              "onPass": {
                "enabled": true,
                "minPassConditions": 1,
                "conditions": [
                  {
                    "enabled": true,
                    "required": false,
                    "method": "MakeTrade",
                    "args": ["CloseShort"]
                  }
                ]
              }
            }
          }
        }
      }
    }
  }
  
  </pre>
</body>
</html>
