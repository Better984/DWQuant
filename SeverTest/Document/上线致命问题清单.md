# 上线致命问题清单（ServerTest）

目标：列出“上线必定出问题”或“极低容错”的代码点，并说明是什么、为什么、怎么做。

## 致命 / 必定出问题

### 1) MarketDataTask 被多个消费者分流，导致策略或推送丢事件
- 是什么：`MarketDataEngine` 只有一个 `Channel<MarketDataTask>`，但 `RealTimeStrategyEngine` 和 `KlineCloseListenerService` 同时读取。
- 为什么会出问题：`Channel` 多读者会“分流”而不是“广播”，同一条任务只会被一个消费者拿到，导致策略执行或行情推送随机缺失。
- 怎么做：
  - 方案 A：为每个消费者建立独立的通道，`MarketDataEngine` 入队时复制并写入多个通道。
  - 方案 B：改成事件/发布订阅模型（如 `IObservable`/`ChannelReader` 每订阅者独立队列）。
  - 方案 C：K 线推送直接由 `MarketDataEngine` 触发，不消费策略通道。
- 代码位置：`SeverTest/Modules/MarketStreaming/Application/MarketDataEngine.cs:40`，`SeverTest/Modules/StrategyEngine/Application/RealTimeStrategyEngine.cs:121`，`SeverTest/Modules/MarketStreaming/Application/KlineCloseListenerService.cs:34`

### 2) 策略动作队列无人消费，导致动作永不执行且内存无限增长
- 是什么：`QueuedStrategyActionExecutor` 只负责入队 `StrategyActionTaskQueue`，但项目中没有任何消费/执行队列的后台服务。
- 为什么会出问题：动作永远不执行；策略产生的任务持续堆积，最终 OOM。
- 怎么做：
  - 增加 `BackgroundService` 作为消费者，出队并执行真实的下单/通知逻辑。
  - 或者移除队列，直接在 `IStrategyActionExecutor` 中同步/异步执行。
  - 将队列改为有界通道并加监控/丢弃策略，避免无限堆积。
- 代码位置：`SeverTest/Modules/StrategyEngine/Application/QueuedStrategyActionExecutor.cs:43`，`SeverTest/Modules/StrategyEngine/Application/StrategyActionTaskQueue.cs:8`，`SeverTest/Program.cs:108`

### 3) 价格订阅被 _exchanges.Count < 3 卡死，任何一家交易所异常都会导致全量价格不更新
- 是什么：`ExchangePriceService.StartPriceSubscriptionsAsync` 在启动订阅前死等 `_exchanges.Count < 3` 变成 3。
- 为什么会出问题：只要任意交易所初始化失败或被禁用，订阅逻辑永远不启动，导致价格数据为空，行情推送也无数据。
- 怎么做：
  - 只等待“必须”的交易所（当前仅 Binance），或改成逐个交易所就绪即启动。
  - 为初始化增加超时与降级策略；不阻塞已就绪的订阅。
- 代码位置：`SeverTest/Modules/MarketStreaming/Application/ExchangePriceService.cs:64`

### 4) 服务端强绑定 WinForms/Windows，非 GUI/非 Windows 环境无法启动
- 是什么：项目目标为 `net8.0-windows` 且启用 WinForms，`Program` 无条件启动 `StartupMonitorHost`。
- 为什么会出问题：Linux/容器/Windows Service 等无 GUI 环境会启动失败或异常挂起，直接无法上线。
- 怎么做：
  - 将监控 UI 独立为单独应用；或仅在开发环境启动（`IsDevelopment`）。
  - 服务器项目改为 `net8.0`，移除 `UseWindowsForms` 依赖。
- 代码位置：`SeverTest/ServerTest.csproj:5`，`SeverTest/ServerTest.csproj:6`，`SeverTest/Program.cs:143`，`SeverTest/Modules/Monitoring/Application/StartupMonitorHost.cs:41`

## 极低容错 / 高风险

### 5) 交易所初始化失败被吞掉，系统仍被标记为“就绪”
- 是什么：`MarketDataEngine.InitializeExchangesAsync` 捕获异常只记录日志，不向外抛；`Program` 仍标记 `MarketDataEngine` 为 Ready。
- 为什么会出问题：初始化失败时系统仍对外服务，健康检查与 readiness 判断失真，策略/行情功能处于“假就绪”状态，易造成错误决策或空数据。
- 怎么做：
  - 失败时抛出异常或明确标记 `SystemStartupManager.MarkFailed`。
  - `WaitForInitializationAsync` 应感知失败并阻止系统进入 Ready。
- 代码位置：`SeverTest/Modules/MarketStreaming/Application/MarketDataEngine.cs:165`，`SeverTest/Program.cs:195`

### 6) 历史数据预热无限缓存，启动即可能 OOM/长时间阻塞
- 是什么：`PreloadEnabled=true` 且 `MaxCacheBars=0` 等价于无限缓存；启动时会将大量历史数据加载进内存。
- 为什么会出问题：历史数据量一旦增长，启动时间不可控，内存占用飙升导致 OOM 或频繁 GC。
- 怎么做：
  - 生产环境关闭 `PreloadEnabled` 或设置合理 `MaxCacheBars`。
  - 引入按需缓存/淘汰策略（LRU/分层缓存）避免全量加载。
- 代码位置：`SeverTest/appsettings.json:19`，`SeverTest/appsettings.json:27`，`SeverTest/Modules/MarketData/Application/HistoricalMarketDataSyncHostedService.cs:40`，`SeverTest/Modules/MarketData/Application/HistoricalMarketDataCache.cs:181`

### 7) 生产密钥/口令硬编码在仓库内，极易泄漏
- 是什么：数据库 root 口令与 JWT Secret 直接写入 `appsettings.json`。
- 为什么会出问题：一旦代码泄漏或被复制到公共环境，数据库与鉴权完全失守。
- 怎么做：
  - 将敏感配置移到环境变量/Secret Manager/密钥服务。
  - 上线前强制轮换 DB 密码与 JWT Secret。
- 代码位置：`SeverTest/appsettings.json:10`，`SeverTest/appsettings.json:30`

### 8) 登录/注册与匿名请求缺少有效限流，易被暴力破解或 DoS
- 是什么：`HttpRateLimitMiddleware` 对 `/api/auth/login`、`/api/auth/register` 直接放行；匿名请求也因缺少 userId 而不触发限流。
- 为什么会出问题：公网环境下极易被爆破/刷接口，造成账号风险或服务不可用。
- 怎么做：
  - 增加 IP/设备级限流或全局漏桶。
  - 对登录、注册单独设置更严格的限流与验证码。
- 代码位置：`SeverTest/Modules/Shared/RateLimit/HttpRateLimitMiddleware.cs:12`，`SeverTest/Modules/Shared/RateLimit/HttpRateLimitMiddleware.cs:30`，`SeverTest/Modules/Shared/RateLimit/RedisRateLimiter.cs:47`
