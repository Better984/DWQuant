# 策略系统（当前实现说明）

本文档以 **当前代码与数据库实现** 为准，整理策略系统的模型、接口与流程。

---

## 1. 核心模型（当前实现）

当前实现未使用 `strategy_instance`，而是使用 `user_strategy` 表承载“用户侧策略实例”。

- StrategyDef: `strategy_def`（策略定义/源策略）
- StrategyVersion: `strategy_version`（策略版本）
- UserStrategy: `user_strategy`（用户实例/持有策略）
- ShareCode: `share_code`（分享入口）
- ShareEvent: `share_event`（分享事件）
- ImportLog: `strategy_import_log`（导入审计）

---

## 2. 数据库表结构（实际库）

### 2.1 `strategy_def`
- def_id (PK)
- creator_uid
- def_type
- name
- description
- latest_version_id (当前最新版本，仅用于草稿/更新)
- created_at
- updated_at

### 2.2 `strategy_version`
- version_id (PK)
- def_id
- version_no
- content_hash
- config_json
- artifact_uri
- changelog
- created_by
- created_at

### 2.3 `user_strategy`
- us_id (PK)
- uid
- def_id
- pinned_version_id
- alias_name
- description
- state (completed/running/paused/paused_open_position/archived；历史数据可能有 draft/ready)
- visibility (private/shared/public_sale)
- share_code (当前绑定的分享码)
- price_usdt
- source_type (custom/template/share_code)
- source_ref (建议存 import_log.id)
- exchange_api_key_id (绑定的交易所API key，运行时使用)
- created_at
- updated_at

### 2.4 `share_code`
- share_code (PK)
- def_id
- created_by_uid
- policy_json
- is_active
- expired_at
- created_at

### 2.5 `share_event`
- event_id (PK)
- share_code
- def_id
- from_uid
- to_uid
- from_instance_id
- to_instance_id
- event_type (create_code/claim/fork)
- created_at

### 2.6 `strategy_import_log`
- id (PK)
- uid
- us_id
- source_type
- source_ref
- created_at

---

## 3. 关键流程与接口（实际实现）

说明：所有接口需要 `Authorization: Bearer <jwt>`。

### 3.0 通用响应格式
所有接口返回统一结构（ApiResponse）：
```json
{
  "success": true,
  "message": "操作成功",
  "data": { },
  "timestamp": "2026-01-26T01:02:03Z"
}
```

失败示例：
```json
{
  "success": false,
  "message": "错误原因",
  "data": null,
  "timestamp": "2026-01-26T01:02:03Z"
}
```

### 3.1 创建策略
**POST** `/api/strategy/create`

请求：
```json
{
  "name": "我的策略",
  "description": "备注",
  "aliasName": "用户侧名称",
  "configJson": { "trade": {}, "logic": {} }
}
```

流程：
- INSERT `strategy_def`
- INSERT `strategy_version` (version_no=1)
- INSERT `user_strategy` (state=completed, visibility=private)
- UPDATE `strategy_def.latest_version_id`

响应 data：
```json
{ "defId": 1001, "usId": 5001, "versionId": 9001, "versionNo": 1 }
```

校验：name<=64，description<=255，aliasName<=64。

---

### 3.2 修改策略（生成新版本）
**POST** `/api/strategy/update`

请求：
```json
{ "usId": 5001, "configJson": { ... }, "changelog": "..." }
```

流程：
- 校验 `user_strategy.us_id` 归属
- INSERT `strategy_version` (version_no=MAX+1)
- UPDATE `user_strategy.pinned_version_id`
- 若 def_type=custom 且创建者是当前用户：更新 `strategy_def.latest_version_id`

响应 data：
```json
{ "usId": 5001, "newVersionId": 9002, "newVersionNo": 2 }
```

---

### 3.3 发布版本（更新用户实例绑定版本）
**POST** `/api/strategy/publish`

请求：
```json
{ "usId": 5001, "versionId": 9002, "stateAfterPublish": "running", "changelog": "..." }
```

流程：
- 校验版本属于 def_id
- UPDATE `user_strategy.pinned_version_id`
- 可选更新 `user_strategy.state`
- 可选更新 `strategy_version.changelog`
- 若 def_type=template 且创建者是当前用户：更新 `strategy_def.latest_version_id`

响应 data：
```json
{ "usId": 5001, "pinnedVersionId": 9002, "state": "running" }
```

备注：当前无 `strategy_version.status/published_at` 字段，发布仅体现在用户实例绑定。

---

### 3.4 策略列表（用户全部实例）
**GET** `/api/strategy/list`

返回字段：
```json
[
  {
    "usId": 5001,
    "defId": 1001,
    "defName": "策略名",
        "aliasName": "用户名称",
        "description": "...",
        "state": "completed",
        "versionNo": 2,
        "exchangeApiKeyId": 12345,
        "configJson": { ... },
        "updatedAt": "2026-01-26T01:02:03"
      }
    ]
```

SQL：
- `user_strategy` + `strategy_def` + `strategy_version(pinned)` 联查。

---

### 3.5 版本列表
**GET** `/api/strategy/versions?usId=5001`

返回字段：
```json
[
  {
    "versionId": 9001,
    "versionNo": 1,
    "changelog": "",
    "configJson": { ... },
    "createdAt": "2026-01-23T12:00:00",
    "isPinned": true
  }
]
```

---

### 3.6 删除策略实例
**POST** `/api/strategy/delete`

请求：
```json
{ "usId": 5001 }
```

动作：删除 `user_strategy` 记录。

---

### 3.7 创建分享码
**POST** `/api/strategy/share/create-code`

请求：
```json
{
  "usId": 5001,
  "policy": {
    "canFork": true,
    "maxClaims": 100,
    "expiredAt": "2026-01-30T12:00:00"
  }
}
```

流程：
- 生成 8 位分享码（A-Z/0-9，格式 `XXXX-XXXX`）
- 若已有 share_code，先 `share_code.is_active=0`
- INSERT `share_code`
- UPDATE `user_strategy.visibility='shared'`, `share_code=...`
- INSERT `share_event` (event_type='create_code')

响应 data：
```json
{ "usId": 5001, "visibility": "shared", "shareCode": "QS9F-45QS" }
```

---

### 3.8 通过分享码导入策略
**POST** `/api/strategy/import/share-code`

请求：
```json
{ "shareCode": "QS9F-45QS", "aliasName": "我导入的策略" }
```

流程：
- 校验 share_code：is_active、expired_at、policy_json(canFork/maxClaims)
- 通过 share_code 找源 user_strategy
- INSERT `user_strategy` (state=completed, source_type='share_code', pinned_version_id 复用源)
- INSERT `strategy_import_log`
- UPDATE `user_strategy.source_ref = importLogId`
- INSERT `share_event` (event_type='claim')

响应 data：
```json
{ "newUsId": 7001, "defId": 1001, "pinnedVersionId": 9002, "sourceType": "share_code", "importLogId": 551233 }
```

---

### 3.9 策略运行状态
**PATCH** `/api/strategy/instances/{id}/state`

请求：
```json
{ "state": "running", "exchangeApiKeyId": 12345 }
```

允许状态：`completed` / `running` / `paused` / `paused_open_position`

行为：
- 更新 `user_strategy.state`
- `running` / `paused_open_position`：需要绑定交易所API key，并加载策略进入 `RealTimeStrategyEngine`
- `paused` / `completed`：从 `RealTimeStrategyEngine` 移除
- `paused_open_position`：只执行平仓逻辑，不再开新仓
- 若 `exchangeApiKeyId` 未传：自动回填该策略交易所的最新 API key（updated_at DESC）
- 若 API key 对应交易所与策略配置不一致：自动创建新版本并同步 `trade.exchange`，同时更新 `pinned_version_id`
- 更新/回填 `user_strategy.exchange_api_key_id`

响应 data：
```json
{ "usId": 5001, "state": "running", "exchangeApiKeyId": 12345 }
```

---

## 4. 分享链路闭环说明（现状）

- `share_code` 记录分享入口与权限（policy_json / expired_at）。
- `share_event` 记录分享行为：
  - create_code: 创建分享码
  - claim: 导入分享码
- `strategy_import_log` 记录导入来源，可用于审计与溯源。
- 当前未实现“分享链查询”和“分享使用统计”接口，但表结构已完整。

---

## 5. 新增协议清单（相对原设计）

以下接口为当前系统实现所新增或替换的协议路径：

- `POST /api/strategy/create`（替代原 `/api/strategy/defs`）
- `POST /api/strategy/update`（替代原 `PUT /api/strategy/defs/{defId}/drafts`）
- `POST /api/strategy/publish`（替代原 `POST /api/strategy/defs/{defId}/versions/{versionId}/publish`）
- `GET /api/strategy/list`（新增，用户策略列表）
- `GET /api/strategy/versions`（新增，策略版本列表）
- `POST /api/strategy/delete`（新增，删除策略实例）
- `PATCH /api/strategy/instances/{id}/state`（新增，策略状态变更）
- `POST /api/strategy/share/create-code`（替代原 `/api/share/codes`）
- `POST /api/strategy/import/share-code`（替代原 `/api/share/codes/{shareCode}/claim`）

未实现但文档提及的协议：`/api/share/codes/{shareCode}/chain`、`/api/share/users/{fromUid}/used-by`。

---

## 6. 实现状态清单（以当前开发为准）

### 已完成
- 创建策略 / 修改策略 / 发布版本 / 删除策略
- 用户策略列表与版本列表
- 运行状态接口：`/api/strategy/instances/{id}/state`
- 分享码创建（含权限、次数、过期时间）
- 分享码导入（含 import_log 与 share_event 记录）
- 分享码格式：固定 8 位，形如 `QS9F-45QS`

### 部分完成 / 与文档不一致
- **实例模型**：当前使用 `user_strategy`，未使用文档中的 `strategy_instance`。
- **发布模型**：无 `strategy_version.status/published_at` 字段；发布仅更新 `user_strategy.pinned_version_id`。
- **strategy_def 字段**：无 `latest_published_version_id`、`is_public`、`tags_json`、`meta_json`。

### 未实现
- 分享链路查询接口：`/api/share/codes/{shareCode}/chain`
- 分享使用统计接口：`/api/share/users/{fromUid}/used-by`
- 分享 fork 行为（share_event 的 fork 事件暂无实际调用）
- 公开售卖策略相关逻辑（public_sale / price_usdt 业务）

---

## 7. 备注

- 版本号策略：每次修改新增一条 `strategy_version`，version_no = MAX + 1。
- 分享码策略：只保留一个 active 分享码，新码会废弃旧码。
- 权限校验：所有接口依赖 JWT，且对 `user_strategy.us_id` 进行归属校验。
- 启动时会尝试为可运行策略自动回填 `exchange_api_key_id`；找不到可用 API key 的策略会被跳过加载。

如需按文档原设计继续补齐功能，可在此文档基础上逐项扩展。
