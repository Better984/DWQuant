# 实盘仓位管理方案（DWQuant）

> 目标：服务端持久化每个策略实例的开仓/持仓/平仓全过程，提供按策略实例/用户+时间范围查询的 API；对未平仓仓位进行实时止盈止损/移动止盈止损检测，并通过 ccxt 执行平仓。

---

## 0. 文档范围

- **适用范围**：C# 后端 + React 前端的实盘量化系统（DWQuant）。
- **约定**：本文 API 输出基于 `ApiResponse<T>`，时间参数统一使用 ISO8601（UTC）。
- **目的**：可直接用于前后端联调与后端开发落地。

---

## 1. 需求与约束

### 1.1 业务需求
- **仓位存储**：服务器端存储所有策略实例的每一次开仓与仓位状态。
- **查询能力**：提供 API 按 **策略实例ID(us_id)** 或 **用户ID(uid)** + **时间范围** 查询仓位列表，返回：
  - 未平仓 / 已平仓
  - 是否触发移动止盈/止损
  - 当前止盈止损价格、触发时间、触发原因
- **风控执行**：对未平仓仓位进行实时行情检查（止盈、止损、移动止盈/止损），并通过 ccxt 执行平仓。

### 1.2 已有框架约束（现状）
- 策略引擎：`RealTimeStrategyEngine` 只产出 `StrategyActionTask`。
- 动作队列：`StrategyActionTaskQueue` 已存在，但目前没有消费者。
- 下单执行：`IStrategyActionExecutor` 已有 `CcxtStrategyActionExecutor`（目前 DryRun）。
- 行情引擎：`MarketDataEngine` 通过 `Channel<MarketDataTask>` 输出任务。

**结论**：必须新增“动作队列消费者 + 仓位管理 + 风控引擎”，并保证行情分发不会丢任务。

---

### 1.3 核对结果与落地补丁（针对现状）
- **数据库缺口**：`strategy_position / strategy_order / strategy_order_fill / strategy_position_event` 均不存在，需新增。
- **数据库风格对齐**：当前库多为 `utf8mb4_0900_ai_ci`、`ROW_FORMAT=DYNAMIC`、`datetime(3)`/`timestamp(3)`，新表保持一致。
- **策略来源缺口**：实盘仅加载本地 `teststrategy.json`，需补齐数据库加载与运行时注册。
- **动作任务缺口**：`StrategyActionTask` 无 `uid/us_id/qty/price/exchange_api_key_id` 等关键字段，无法真实下单。
- **队列消费缺口**：`QueuedStrategyActionExecutor` 仅入队，必须新增消费服务。
- **行情分流风险**：`MarketDataTask` 单通道，多消费者会分流丢任务；新增风控会加剧问题。
- **下单执行缺口**：`CcxtStrategyActionExecutor` 仅 DryRun，需实现真实下单。
- **风控数据缺口**：`MarketDataTask` 不含 OHLC，风控需从 `MarketDataEngine.GetLatestKline` 补拉或扩展 MarketDataTask。

**优化与修正方案（落地版）**
1. **数据模型补齐**：新增四张表，并补字段 `exchange_api_key_id`、`strategy_uid(128)`、`risk_snapshot_json`、`trailing_activation_pct/drawdown_pct`。
2. **任务模型升级**：新增 `StrategyActionTaskV2`（或扩展现有字段），至少包含：`uid/us_id/exchange_api_key_id/exchange/symbol/side/qty/price/timeframe_sec`。
3. **消费者上线**：新增 `TradeActionConsumer` 后台服务，消费动作队列并落地订单/仓位。
4. **行情扇出**：引入 `MarketDataHub`，保证策略引擎/风控/推送各自通道不丢任务。
5. **风控引擎落地**：`PositionRiskEngine` 订阅行情，触发平仓动作入队。
6. **真实下单执行**：在 `IOrderExecutor` 内实现 ccxt 下单并对账。

### 1.4 任务模型与执行器统一约定（落地口径）
为避免实现卡住，明确 **统一口径**：
1. **策略引擎 → 动作队列**：继续使用现有 `StrategyActionTask`，但**扩展字段**并版本化，形成 **StrategyActionTaskV2**（新增字段不破坏旧逻辑）。
2. **动作队列 → 交易所下单**：由新的 `IOrderExecutor` 承担真实下单；`IStrategyActionExecutor` 继续负责“生成任务入队”。
3. **兼容策略**：若任务缺少 `uid/us_id/exchange_api_key_id` 等关键字段，则通过 `strategy_uid` 回查 `user_strategy` + `strategy_version` 补齐。

**StrategyActionTaskV2（扩展字段清单）**
```csharp
public sealed class StrategyActionTaskV2
{
    // 原有字段
    public string StrategyUid { get; init; } = string.Empty;
    public string Stage { get; init; } = string.Empty;
    public MarketDataTask MarketTask { get; init; }
    public string Method { get; init; } = string.Empty;
    public string[] Param { get; init; } = Array.Empty<string>();
    public IReadOnlyList<ConditionEvaluationSnapshot> TriggerResults { get; init; } =
        Array.Empty<ConditionEvaluationSnapshot>();
    public DateTimeOffset CreatedAt { get; init; } = DateTimeOffset.UtcNow;

    // 新增字段（可空，允许旧任务补全）
    public long? Uid { get; init; }
    public long? UsId { get; init; }
    public long? ExchangeApiKeyId { get; init; }
    public string? Exchange { get; init; }
    public string? Symbol { get; init; }
    public int? TimeframeSec { get; init; }
    public string? PositionSide { get; init; } // Long/Short
    public decimal? Qty { get; init; }
    public decimal? Price { get; init; }
    public string? OrderIntent { get; init; } // Open/Close/Reduce/Reverse
    public string? ClientOrderId { get; init; }
}
```

**执行器命名与责任边界**
- `IStrategyActionExecutor`：策略引擎侧，用于生成并入队动作任务（当前已存在 `QueuedStrategyActionExecutor`）。
- `IOrderExecutor`：交易执行侧，用于真实下单/撤单（新引入，供 `TradeActionConsumer` 调用）。
- **适配建议**：新增 `CcxtOrderExecutor : IOrderExecutor`（独立实现真实下单），保留 `CcxtStrategyActionExecutor` 作为“模拟/调试”执行器，或让其实现 `IOrderExecutor` 并由 `TradeActionConsumer` 复用。

### 1.5 策略来源与运行加载流程（落地方案）
为补齐“仅加载本地 JSON”的缺口，建议：
1. **启动加载**：`StrategyRuntimeBootstrapHostedService` 启动时从 `user_strategy` 查询 `state=running|paused_open_position|testing` 的策略实例 → 关联 `strategy_version` 读取 `config_json` → 通过 `StrategyJsonLoader` 组装并注册到 `RealTimeStrategyEngine`。
2. **热更新/发布**：策略发布（切版本/状态变更）后，通过事件或轮询刷新运行时策略（推荐 30-60s 轮询兜底）。
3. **失败回退**：
   - DB 不可用时，继续运行已缓存策略；
   - 若单条策略加载失败，记录错误并跳过，不影响其他策略运行；
   - 可保留 `teststrategy.json` 作为开发环境 fallback。

### 1.6 行情扇出（MarketDataHub）落地方案
现有 `MarketDataEngine` 只有单通道，新增风控消费者会导致任务分流丢失。建议引入 Hub：
```csharp
public sealed class MarketDataHub
{
    private readonly ConcurrentDictionary<string, Channel<MarketDataTask>> _channels = new();

    public ChannelReader<MarketDataTask> Subscribe(string consumerName)
        => _channels.GetOrAdd(consumerName, _ => Channel.CreateUnbounded<MarketDataTask>()).Reader;

    public void Publish(MarketDataTask task)
    {
        foreach (var channel in _channels.Values)
        {
            channel.Writer.TryWrite(task);
        }
    }
}
```
**改造点**
- `MarketDataEngine.EnqueueMarketTask` 改为调用 `MarketDataHub.Publish`。
- `RealTimeStrategyEngine` / `KlineCloseListenerService` / `PositionRiskEngine` 各自订阅独立通道。
- 需要限流/背压时，可改为有界通道 + drop policy。

### 1.7 时间语义统一（必须明确）
- **数据库存储**：统一 **UTC**（`datetime(3)`）；
- **API 输入输出**：统一 **UTC**（ISO8601，`2026-01-27T08:00:00Z`），不再使用本地时间字符串；
- 若前端需要本地时间展示，应在客户端转换；服务端不再混用本地格式。

## 2. 方案总览

### 2.1 设计目标
- 一次开仓 = 一条 **Position**，全生命周期持久化。
- 所有订单/成交单独记录，可对账可回溯。
- 实时行情驱动风控引擎 → 自动触发平仓。
- API 支持按用户/策略实例/时间范围检索。

### 2.2 核心模块
1. **TradeActionConsumer**（动作队列消费者）
   - 消费 `StrategyActionTaskQueue`
   - 生成下单请求（开仓/平仓）
   - 更新仓位与订单数据

2. **PositionManager**（仓位域服务）
   - 统一管理开仓/加仓/减仓/平仓/反向
   - 负责持久化与内存缓存同步

3. **PositionRiskEngine**（风控引擎）
   - 订阅行情（1m/更快）
   - 检测止盈/止损/移动止盈/止损
   - 触发平仓动作入队

4. **MarketDataHub**（行情扇出）
   - 避免 `MarketDataTask` 多消费者分流丢任务
   - 每个消费者独立通道（策略引擎 / 风控引擎 / 推送服务）

5. **ExchangeSyncService**（交易所对账/纠偏）
   - 周期性拉取交易所仓位/订单，与本地状态对齐

---

## 3. 数据模型与表结构（详细版）

### 3.1 状态与枚举定义（建议统一为字符串枚举）

**PositionStatus**
- `Open`：已开仓，未进入平仓流程
- `Closing`：已触发平仓/风控，订单处理中
- `Closed`：已完全平仓
- `Failed`：开仓失败或异常终止

**PositionSide**
- `Long`
- `Short`

**OrderStatus**
- `New`
- `PartiallyFilled`
- `Filled`
- `Canceled`
- `Rejected`
- `Expired`

**OrderSide**
- `buy`
- `sell`

**OrderIntent**
- `Open`
- `Close`
- `Reduce`
- `Reverse`

**EventType**
- `Open`
- `OpenFilled`
- `Close`
- `CloseFilled`
- `StopLossHit`
- `TakeProfitHit`
- `TrailingActivated`
- `TrailingUpdated`
- `TrailingHit`
- `ManualClose`
- `ForceClose`
- `SyncAdjust`
- `Error`

**CloseReason**
- `StopLoss`
- `TakeProfit`
- `TrailingStop`
- `Manual`
- `Reverse`
- `Force`
- `Sync`
- `Unknown`

---

### 3.2 strategy_position（仓位主表）

**用途**：记录单次开仓的完整生命周期与风控状态。

**字段清单（修正版）**

| 字段 | 类型 | 允许空 | 说明 |
|---|---|---|---|
| position_id | BIGINT | 否 | PK，仓位ID |
| uid | BIGINT | 否 | 用户ID |
| us_id | BIGINT | 否 | 策略实例ID |
| strategy_uid | VARCHAR(128) | 是 | 策略 UID Code |
| strategy_version_id | BIGINT | 是 | 策略版本ID |
| exchange_api_key_id | BIGINT | 是 | 绑定 `user_exchange_api_keys.id` |
| exchange | VARCHAR(32) | 否 | 交易所（小写规范化） |
| symbol | VARCHAR(32) | 否 | 交易对（如 BTC/USDT） |
| timeframe_sec | INT | 是 | 策略周期秒数 |
| side | VARCHAR(8) | 否 | Long/Short |
| position_mode | VARCHAR(16) | 否 | Cross/Isolated |
| leverage | INT | 否 | 杠杆 |
| entry_price | DECIMAL(18,8) | 否 | 开仓均价 |
| qty | DECIMAL(18,8) | 否 | 当前持仓数量 |
| notional | DECIMAL(18,8) | 否 | 名义价值 |
| status | VARCHAR(16) | 否 | Open/Closing/Closed/Failed |
| stop_loss_price | DECIMAL(18,8) | 是 | 止损价 |
| take_profit_price | DECIMAL(18,8) | 是 | 止盈价 |
| trailing_enabled | TINYINT | 否 | 是否启用移动止盈 |
| trailing_activation_price | DECIMAL(18,8) | 是 | 激活价 |
| trailing_activation_pct | DECIMAL(10,6) | 是 | 激活比例（快照） |
| trailing_drawdown_pct | DECIMAL(10,6) | 是 | 回撤比例（快照） |
| trailing_stop_price | DECIMAL(18,8) | 是 | 当前移动止损价 |
| max_favorable_price | DECIMAL(18,8) | 是 | 最大有利价 |
| trailing_triggered | TINYINT | 否 | 是否已触发移动止盈 |
| trailing_triggered_at | DATETIME(3) | 是 | 触发时间(UTC) |
| last_price | DECIMAL(18,8) | 是 | 最后一次行情价 |
| last_check_at | DATETIME(3) | 是 | 最后一次风控检查时间(UTC) |
| close_reason | VARCHAR(16) | 是 | StopLoss/TakeProfit/TrailingStop/Manual/Sync... |
| open_order_id | BIGINT | 是 | 开仓订单ID（本地） |
| close_order_id | BIGINT | 是 | 最近一次平仓订单ID（本地） |
| risk_snapshot_json | JSON | 是 | 风控配置快照 |
| opened_at | DATETIME(3) | 否 | 开仓时间(UTC) |
| closed_at | DATETIME(3) | 是 | 平仓时间(UTC) |
| realized_pnl | DECIMAL(18,8) | 是 | 已实现盈亏 |
| fees | DECIMAL(18,8) | 是 | 手续费 |
| created_at | DATETIME(3) | 否 | 创建时间 |
| updated_at | DATETIME(3) | 否 | 更新时间 |

**SQL（带注释，风格对齐）**
```sql
CREATE TABLE strategy_position (
  position_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '仓位ID',
  uid BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  us_id BIGINT UNSIGNED NOT NULL COMMENT '策略实例ID',
  strategy_uid VARCHAR(128) NULL COMMENT '策略UID Code',
  strategy_version_id BIGINT UNSIGNED NULL COMMENT '策略版本ID',
  exchange_api_key_id BIGINT UNSIGNED NULL COMMENT '绑定 user_exchange_api_keys.id',

  exchange VARCHAR(32) NOT NULL COMMENT '交易所(规范化)',
  symbol VARCHAR(32) NOT NULL COMMENT '交易对(如 BTC/USDT)',
  timeframe_sec INT NULL COMMENT '策略周期(秒)',
  side VARCHAR(8) NOT NULL COMMENT '方向: Long/Short',
  position_mode VARCHAR(16) NOT NULL COMMENT '仓位模式: Cross/Isolated',
  leverage INT NOT NULL DEFAULT 1 COMMENT '杠杆',

  entry_price DECIMAL(18,8) NOT NULL COMMENT '开仓均价',
  qty DECIMAL(18,8) NOT NULL COMMENT '持仓数量',
  notional DECIMAL(18,8) NOT NULL COMMENT '名义价值',

  status VARCHAR(16) NOT NULL COMMENT '状态: Open/Closing/Closed/Failed',

  stop_loss_price DECIMAL(18,8) NULL COMMENT '止损价',
  take_profit_price DECIMAL(18,8) NULL COMMENT '止盈价',

  trailing_enabled TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否启用移动止盈',
  trailing_activation_price DECIMAL(18,8) NULL COMMENT '移动止盈激活价',
  trailing_activation_pct DECIMAL(10,6) NULL COMMENT '移动止盈激活比例(快照)',
  trailing_drawdown_pct DECIMAL(10,6) NULL COMMENT '移动止盈回撤比例(快照)',
  trailing_stop_price DECIMAL(18,8) NULL COMMENT '移动止损价',
  max_favorable_price DECIMAL(18,8) NULL COMMENT '最大有利价',
  trailing_triggered TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否已触发移动止盈',
  trailing_triggered_at DATETIME(3) NULL COMMENT '移动止盈触发时间(UTC)',

  last_price DECIMAL(18,8) NULL COMMENT '最后检查价格',
  last_check_at DATETIME(3) NULL COMMENT '最后检查时间(UTC)',

  close_reason VARCHAR(16) NULL COMMENT '平仓原因',
  open_order_id BIGINT UNSIGNED NULL COMMENT '开仓订单ID(本地)',
  close_order_id BIGINT UNSIGNED NULL COMMENT '最近一次平仓订单ID(本地)',
  risk_snapshot_json JSON NULL COMMENT '风控配置快照',

  opened_at DATETIME(3) NOT NULL COMMENT '开仓时间(UTC)',
  closed_at DATETIME(3) NULL COMMENT '平仓时间(UTC)',
  realized_pnl DECIMAL(18,8) NULL COMMENT '已实现盈亏',
  fees DECIMAL(18,8) NULL COMMENT '手续费',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '创建时间',
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3) COMMENT '更新时间',

  PRIMARY KEY (position_id),
  INDEX idx_uid_time (uid, opened_at),
  INDEX idx_usid_time (us_id, opened_at),
  INDEX idx_status (status),
  INDEX idx_symbol (exchange, symbol),
  INDEX idx_api_key_time (exchange_api_key_id, opened_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC;
```

**索引策略说明**
- `idx_uid_time` / `idx_usid_time`：满足用户/策略维度 + 时间范围查询
- `idx_status`：加速未平仓查询（Open/Closing）
- `idx_symbol`：行情维度快速定位仓位
- `idx_api_key_time`：账户维度快速定位仓位

---

### 3.3 strategy_order（订单表）

**用途**：记录策略下单请求与交易所返回。

**字段清单（修正版）**

| 字段 | 类型 | 允许空 | 说明 |
|---|---|---|---|
| order_id | BIGINT | 否 | PK |
| position_id | BIGINT | 是 | 关联仓位 |
| uid | BIGINT | 否 | 用户ID |
| us_id | BIGINT | 否 | 策略实例ID |
| strategy_uid | VARCHAR(128) | 是 | 策略 UID Code |
| exchange_api_key_id | BIGINT | 是 | 绑定 `user_exchange_api_keys.id` |
| exchange | VARCHAR(32) | 否 | 交易所 |
| symbol | VARCHAR(32) | 否 | 交易对 |
| order_side | VARCHAR(8) | 否 | buy/sell |
| order_type | VARCHAR(16) | 否 | market/limit |
| order_intent | VARCHAR(16) | 否 | Open/Close/Reduce/Reverse |
| position_side | VARCHAR(8) | 是 | Long/Short（便于回溯） |
| reduce_only | TINYINT | 否 | 是否 reduceOnly |
| price | DECIMAL(18,8) | 是 | 下单价 |
| qty | DECIMAL(18,8) | 否 | 数量 |
| status | VARCHAR(16) | 否 | New/PartiallyFilled/Filled/Canceled/Rejected/Expired |
| client_order_id | VARCHAR(64) | 是 | 客户端幂等ID |
| exchange_order_id | VARCHAR(64) | 是 | 交易所订单ID |
| request_json | JSON | 是 | 请求报文 |
| response_json | JSON | 是 | 回报报文 |
| error_message | VARCHAR(512) | 是 | 错误描述 |
| created_at | DATETIME(3) | 否 | 创建时间 |
| updated_at | DATETIME(3) | 否 | 更新时间 |

**SQL（带注释，风格对齐）**
```sql
CREATE TABLE strategy_order (
  order_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  position_id BIGINT UNSIGNED NULL COMMENT '关联仓位ID',
  uid BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  us_id BIGINT UNSIGNED NOT NULL COMMENT '策略实例ID',
  strategy_uid VARCHAR(128) NULL COMMENT '策略UID Code',
  exchange_api_key_id BIGINT UNSIGNED NULL COMMENT '绑定 user_exchange_api_keys.id',

  exchange VARCHAR(32) NOT NULL COMMENT '交易所',
  symbol VARCHAR(32) NOT NULL COMMENT '交易对',
  order_side VARCHAR(8) NOT NULL COMMENT '买卖方向: buy/sell',
  order_type VARCHAR(16) NOT NULL COMMENT '订单类型: market/limit',
  order_intent VARCHAR(16) NOT NULL COMMENT '订单意图: Open/Close/Reduce/Reverse',
  position_side VARCHAR(8) NULL COMMENT '仓位方向: Long/Short',
  reduce_only TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否 reduceOnly',

  price DECIMAL(18,8) NULL COMMENT '下单价格',
  qty DECIMAL(18,8) NOT NULL COMMENT '下单数量',

  status VARCHAR(16) NOT NULL COMMENT '订单状态',
  client_order_id VARCHAR(64) NULL COMMENT '客户端幂等ID',
  exchange_order_id VARCHAR(64) NULL COMMENT '交易所订单ID',

  request_json JSON NULL COMMENT '请求报文',
  response_json JSON NULL COMMENT '回报报文',
  error_message VARCHAR(512) NULL COMMENT '错误描述',

  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '创建时间',
  updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3) COMMENT '更新时间',

  PRIMARY KEY (order_id),
  INDEX idx_position (position_id),
  INDEX idx_uid_time (uid, created_at),
  INDEX idx_usid_time (us_id, created_at),
  UNIQUE KEY uk_client_order (exchange_api_key_id, client_order_id),
  UNIQUE KEY uk_exchange_order (exchange_api_key_id, exchange_order_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC;
```

**索引策略说明**
- `uk_client_order`：按账户幂等
- `uk_exchange_order`：避免重复入库

---

### 3.4 strategy_order_fill（成交表）

**用途**：记录成交明细（可能多次成交）。

**SQL（带注释，风格对齐）**
```sql
CREATE TABLE strategy_order_fill (
  fill_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '成交ID',
  order_id BIGINT UNSIGNED NOT NULL COMMENT '订单ID',
  exchange_api_key_id BIGINT UNSIGNED NULL COMMENT '绑定 user_exchange_api_keys.id',
  trade_id VARCHAR(64) NOT NULL COMMENT '交易所成交ID',
  price DECIMAL(18,8) NOT NULL COMMENT '成交价',
  qty DECIMAL(18,8) NOT NULL COMMENT '成交量',
  fee DECIMAL(18,8) NULL COMMENT '手续费',
  fee_asset VARCHAR(16) NULL COMMENT '手续费资产',
  executed_at DATETIME(3) NOT NULL COMMENT '成交时间(UTC)',

  PRIMARY KEY (fill_id),
  INDEX idx_order (order_id),
  UNIQUE KEY uk_trade (exchange_api_key_id, trade_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC;
```

---

### 3.5 strategy_position_event（事件审计表）

**用途**：记录风控触发、移动止盈更新、手动操作等事件。

**SQL（带注释，风格对齐）**
```sql
CREATE TABLE strategy_position_event (
  event_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '事件ID',
  position_id BIGINT UNSIGNED NOT NULL COMMENT '仓位ID',
  uid BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  us_id BIGINT UNSIGNED NOT NULL COMMENT '策略实例ID',
  strategy_uid VARCHAR(128) NULL COMMENT '策略UID Code',

  event_type VARCHAR(32) NOT NULL COMMENT '事件类型',
  close_reason VARCHAR(16) NULL COMMENT '平仓原因',
  event_price DECIMAL(18,8) NULL COMMENT '触发价格',
  detail TEXT NULL COMMENT '描述/扩展信息',
  detail_json JSON NULL COMMENT '结构化扩展信息',
  event_at DATETIME(3) NOT NULL COMMENT '事件时间(UTC)',
  created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) COMMENT '创建时间',

  PRIMARY KEY (event_id),
  INDEX idx_position (position_id),
  INDEX idx_uid_time (uid, event_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC;
```


## 4. API 规范（联调版）

### 4.1 通用规范
- **Base URL**：`/api`
- **认证**：`Authorization: Bearer <token>`
- **响应格式**：
```json
{
  "success": true,
  "message": "操作成功",
  "data": {},
  "timestamp": "2026-01-27T08:00:00Z"
}
```
- **时间格式**：统一使用 ISO8601 UTC（如 `2026-01-27T08:00:00Z`）
- **分页参数**：`page` (1-based), `pageSize` (1-200, 默认 20)
- **排序参数**：`sort` 允许值：`opened_at_desc|opened_at_asc|closed_at_desc|closed_at_asc`

---

### 4.2 API：按用户查询仓位列表
`GET /api/positions`

**Query 参数**
- `uid`：可选（管理员调试用，普通用户忽略）
- `from` / `to`：时间范围
- `timeField`：`opened_at|closed_at`（默认 opened_at）
- `status`：`open|closing|closed|failed|all`（默认 all）
- `trailingTriggered`：`0|1|all`（默认 all）
- `exchange` / `symbol` / `side`：可选过滤
- `page` / `pageSize` / `sort`

**Response.Data**
```json
{
  "page": 1,
  "pageSize": 20,
  "total": 356,
  "items": [
    {
      "positionId": 10001,
      "uid": 123,
      "usId": 456,
      "exchangeApiKeyId": 12,
      "exchange": "binance",
      "symbol": "BTC/USDT",
      "side": "Long",
      "status": "Open",
      "entryPrice": 42000.5,
      "qty": 0.01,
      "stopLossPrice": 41000.0,
      "takeProfitPrice": 45000.0,
      "trailingEnabled": true,
      "trailingTriggered": false,
      "trailingStopPrice": 43200.0,
      "openedAt": "2026-01-27T16:01:00Z",
      "closedAt": null,
      "realizedPnl": null
    }
  ]
}
```

---

### 4.3 API：按策略实例查询仓位列表
`GET /api/positions/by-strategy`

**Query 参数**
- `usId`：必填
- `from` / `to` / `timeField` / `status` / `trailingTriggered`
- `page` / `pageSize` / `sort`

**Response.Data**：同 `/api/positions`

---

### 4.4 API：仓位详情
`GET /api/positions/{positionId}`

**Response.Data**
```json
{
  "positionId": 10001,
  "uid": 123,
  "usId": 456,
  "exchangeApiKeyId": 12,
  "strategyUid": "456",
  "strategyVersionId": 12,
  "exchange": "binance",
  "symbol": "BTC/USDT",
  "timeframeSec": 300,
  "side": "Long",
  "positionMode": "Cross",
  "leverage": 5,
  "entryPrice": 42000.5,
  "qty": 0.01,
  "notional": 420.005,
  "status": "Open",
  "stopLossPrice": 41000.0,
  "takeProfitPrice": 45000.0,
  "trailingEnabled": true,
  "trailingActivationPrice": 43000.0,
  "trailingStopPrice": 43200.0,
  "maxFavorablePrice": 43800.0,
  "trailingTriggered": false,
  "trailingTriggeredAt": null,
  "lastPrice": 43750.0,
  "lastCheckAt": "2026-01-27T16:05:00Z",
  "closeReason": null,
  "openOrderId": 20001,
  "closeOrderId": null,
  "openedAt": "2026-01-27T16:01:00Z",
  "closedAt": null,
  "realizedPnl": null,
  "fees": 0.02
}
```

---

### 4.5 API：仓位事件列表
`GET /api/positions/{positionId}/events`

**Query 参数**
- `from` / `to`
- `page` / `pageSize` / `sort`

**Response.Data**
```json
{
  "page": 1,
  "pageSize": 50,
  "total": 3,
  "items": [
    {
      "eventId": 9001,
      "eventType": "TrailingActivated",
      "detail": "触发价=43000.0，激活移动止盈",
      "createdAt": "2026-01-27T16:03:00Z"
    }
  ]
}
```

---

### 4.6 API：手动平仓（掌控能力）
`POST /api/positions/{positionId}/close`

**Body**
```json
{
  "reason": "Manual",
  "reduceOnly": true,
  "orderType": "market",
  "price": null,
  "clientOrderId": "manual-close-10001"
}
```

**Response.Data**
```json
{
  "positionId": 10001,
  "status": "Closing",
  "closeOrderId": 20123
}
```

---

### 4.7 API：调整止盈/止损/移动止盈（可选）
`PATCH /api/positions/{positionId}/risk`

**Body**
```json
{
  "stopLossPrice": 41500.0,
  "takeProfitPrice": 45500.0,
  "trailing": {
    "enabled": true,
    "activationPrice": 43200.0,
    "drawdownPct": 0.02
  }
}
```

**Response.Data**
```json
{
  "positionId": 10001,
  "stopLossPrice": 41500.0,
  "takeProfitPrice": 45500.0,
  "trailingEnabled": true,
  "trailingActivationPrice": 43200.0
}
```

---

### 4.8 错误返回示例
```json
{
  "success": false,
  "message": "无效的时间范围",
  "data": null,
  "timestamp": "2026-01-27T08:00:00Z"
}
```

---

## 5. 风控逻辑（止盈/止损/移动止盈）

### 5.1 固定止盈/止损
- **Long**：
  - 止盈触发：`price >= take_profit_price`
  - 止损触发：`price <= stop_loss_price`
- **Short**：
  - 止盈触发：`price <= take_profit_price`
  - 止损触发：`price >= stop_loss_price`

### 5.2 移动止盈（Trailing Stop）
以 Long 为例：
1) 激活条件：`price >= entry_price * (1 + activation_pct)`
2) 记录 `max_favorable_price`
3) 更新移动止损价：
   - `trailing_stop_price = max_favorable_price * (1 - drawdown_pct)`
4) 触发条件：`price <= trailing_stop_price`

Short 逻辑相反。

### 5.3 同一根K线内同时触发（优先级）
- 若同一根K线 `high/low` 同时触及止盈与止损：
  - **默认优先止损**（保守规则，确保风险收敛）
  - 可通过配置调整为“先止盈”或“按时间序列（需更高频数据）”

### 5.4 触发后的处理
- 生成平仓动作任务 `CloseLong/CloseShort` → 入队
- 记录 `strategy_position_event`
- 更新 `trailing_triggered = 1` 和 `trailing_triggered_at`

---

## 6. 执行流程（整体数据流）

### 6.1 开仓冲突处理细则（OpenConflictPolicy）
- **GiveUp**：已有同方向仓位 → 放弃开仓。
- **Add**：已有同方向仓位 → 允许加仓，但受 `MaxPositionQty` 限制。
- **Reverse**：已有反向仓位 → 先平仓，确认成交后再反向开仓。
- **CloseAndOpen**：已有同方向仓位 → 先平仓再开新仓。
- **部分平仓**：若触发减少仓位，使用 `Reduce` 订单意图并记录 `strategy_order`。
- **MaxPositionQty**：超过上限则拒单并记录事件。

1. **策略引擎** 命中条件 → 产生 `StrategyActionTask`
2. **TradeActionConsumer** 消费任务
   - 检查仓位冲突策略（OpenConflictPolicy）
   - 生成订单 → ccxt 下单
   - 记录 `strategy_order` / `strategy_order_fill`
   - 更新 `strategy_position`
3. **PositionRiskEngine** 订阅行情
   - 检测止盈止损 / 移动止盈
   - 生成平仓任务 → 入队
4. **ExchangeSyncService** 周期对账
   - 修正本地状态

---

## 7. 架构与接口草图（C# 签名）

### 7.1 领域模型（DTO/Query）
```csharp
public sealed class PositionQuery
{
    public long? Uid { get; init; }
    public long? UsId { get; init; }
    public DateTime? From { get; init; }
    public DateTime? To { get; init; }
    public string? TimeField { get; init; } // opened_at / closed_at
    public string? Status { get; init; }    // Open/Closed/Closing/Failed
    public string? Exchange { get; init; }
    public string? Symbol { get; init; }
    public string? Side { get; init; }
    public bool? TrailingTriggered { get; init; }
    public int Page { get; init; } = 1;
    public int PageSize { get; init; } = 20;
    public string Sort { get; init; } = "opened_at_desc";
}

public sealed class PositionSnapshot
{
    public long PositionId { get; init; }
    public long Uid { get; init; }
    public long UsId { get; init; }
    public long? ExchangeApiKeyId { get; init; }
    public string? StrategyUid { get; init; }
    public string Exchange { get; init; } = string.Empty;
    public string Symbol { get; init; } = string.Empty;
    public string Side { get; init; } = "Long";
    public string Status { get; init; } = "Open";
    public decimal EntryPrice { get; init; }
    public decimal Qty { get; init; }
    public decimal? StopLossPrice { get; init; }
    public decimal? TakeProfitPrice { get; init; }
    public bool TrailingEnabled { get; init; }
    public bool TrailingTriggered { get; init; }
    public decimal? TrailingStopPrice { get; init; }
    public DateTime OpenedAt { get; init; }
    public DateTime? ClosedAt { get; init; }
}
```

### 7.2 仓位管理接口（PositionManager）
```csharp
public interface IPositionManager
{
    Task<PositionSnapshot?> GetAsync(long positionId, CancellationToken ct);
    Task<PagedResult<PositionSnapshot>> QueryAsync(PositionQuery query, CancellationToken ct);

    Task<PositionOpenResult> OpenAsync(PositionOpenRequest request, CancellationToken ct);
    Task<PositionCloseResult> CloseAsync(PositionCloseRequest request, CancellationToken ct);
    Task<PositionRiskAdjustResult> AdjustRiskAsync(PositionRiskAdjustRequest request, CancellationToken ct);

    Task UpdateLastPriceAsync(long positionId, decimal lastPrice, DateTime at, CancellationToken ct);
}

public sealed class PositionOpenRequest
{
    public long Uid { get; init; }
    public long UsId { get; init; }
    public long? ExchangeApiKeyId { get; init; }
    public string? StrategyUid { get; init; }
    public string Exchange { get; init; } = string.Empty;
    public string Symbol { get; init; } = string.Empty;
    public string Side { get; init; } = "Long";
    public decimal Qty { get; init; }
    public decimal? Price { get; init; }
    public bool ReduceOnly { get; init; }
    public string? ClientOrderId { get; init; }
}

public sealed class PositionCloseRequest
{
    public long PositionId { get; init; }
    public string Reason { get; init; } = "Manual";
    public bool ReduceOnly { get; init; } = true;
    public string OrderType { get; init; } = "market";
    public decimal? Price { get; init; }
    public string? ClientOrderId { get; init; }
}

public sealed class PositionRiskAdjustRequest
{
    public long PositionId { get; init; }
    public decimal? StopLossPrice { get; init; }
    public decimal? TakeProfitPrice { get; init; }
    public TrailingAdjust? Trailing { get; init; }
}

public sealed class TrailingAdjust
{
    public bool Enabled { get; init; }
    public decimal? ActivationPrice { get; init; }
    public decimal? DrawdownPct { get; init; }
}
```
### 7.3 风控引擎接口（PositionRiskEngine）
```csharp
public interface IPositionRiskEngine
{
    Task HandleMarketTaskAsync(MarketDataTask task, CancellationToken ct);
    Task EvaluatePositionAsync(PositionSnapshot position, MarketSnapshot market, CancellationToken ct);
}

public sealed class MarketSnapshot
{
    public string Exchange { get; init; } = string.Empty;
    public long? ExchangeApiKeyId { get; init; }
    public string Symbol { get; init; } = string.Empty;
    public decimal Last { get; init; }
    public decimal High { get; init; }
    public decimal Low { get; init; }
    public DateTime At { get; init; }
}
```

### 7.4 动作队列消费者（TradeActionConsumer）
**说明**：`StrategyActionTaskQueue` 继续沿用，但任务类型升级为 `StrategyActionTaskV2`（新增字段向后兼容旧任务）。
```csharp
public sealed class TradeActionConsumer : BackgroundService
{
    private readonly StrategyActionTaskQueue _queue;
    private readonly IPositionManager _positionManager;
    private readonly IOrderExecutor _orderExecutor;

    public TradeActionConsumer(
        StrategyActionTaskQueue queue,
        IPositionManager positionManager,
        IOrderExecutor orderExecutor)
    {
        _queue = queue;
        _positionManager = positionManager;
        _orderExecutor = orderExecutor;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        await foreach (var task in _queue.ReadAllAsync(stoppingToken))
        {
            await HandleTaskAsync(task, stoppingToken);
        }
    }

    private async Task HandleTaskAsync(StrategyActionTaskV2 task, CancellationToken ct)
    {
        // 解析 action -> Open/Close
        // 若关键字段缺失，通过 StrategyUid 回查 user_strategy + strategy_version 补齐
        // 调用 PositionManager + OrderExecutor
    }
}
```

### 7.5 订单执行接口（ccxt 适配层）
```csharp
public interface IOrderExecutor
{
    Task<OrderResult> PlaceOrderAsync(OrderRequest request, CancellationToken ct);
    Task<OrderResult> CancelOrderAsync(string exchangeOrderId, CancellationToken ct);
}

public sealed class OrderRequest
{
    public string Exchange { get; init; } = string.Empty;
    public long? ExchangeApiKeyId { get; init; }
    public string Symbol { get; init; } = string.Empty;
    public string OrderType { get; init; } = "market";
    public string Side { get; init; } = "buy";
    public decimal Qty { get; init; }
    public decimal? Price { get; init; }
    public bool ReduceOnly { get; init; }
    public string? ClientOrderId { get; init; }
}
```

### 7.6 Repository 接口草图
```csharp
public interface IPositionRepository
{
    Task<long> InsertAsync(StrategyPositionEntity entity, CancellationToken ct);
    Task UpdateAsync(StrategyPositionEntity entity, CancellationToken ct);
    Task<StrategyPositionEntity?> GetAsync(long positionId, CancellationToken ct);
    Task<PagedResult<StrategyPositionEntity>> QueryAsync(PositionQuery query, CancellationToken ct);
}

public interface IOrderRepository
{
    Task<long> InsertAsync(StrategyOrderEntity entity, CancellationToken ct);
    Task UpdateStatusAsync(long orderId, string status, CancellationToken ct);
    Task<StrategyOrderEntity?> GetByClientOrderIdAsync(string clientOrderId, CancellationToken ct);
}
```

---

## 8. 查询与风控的关键点（针对需求）

- **按策略实例ID查询**：使用 `strategy_position.us_id` + 时间范围 + 状态过滤。
- **按用户ID查询**：使用 `strategy_position.uid` + 时间范围 + 状态过滤。
- **移动止盈状态**：`trailing_enabled` / `trailing_triggered` / `trailing_stop_price` + 事件表追溯。
- **未平仓控制能力**：PositionRiskEngine + TradeActionConsumer + 手动平仓 API。

---

## 9. 推荐落地顺序
1. 建表（position/order/fill/event）
2. 上线 TradeActionConsumer（动作队列消费者）
3. 上线 PositionManager + 基础 TP/SL
4. 上线 Trailing Stop 逻辑
5. 引入 MarketDataHub（解决分流丢任务）
6. 上线 ExchangeSyncService 对账

---

## 10. 对接点（现有代码）
- `StrategyActionTaskQueue`：动作入队入口
- `QueuedStrategyActionExecutor`：仍负责 enqueue
- `CcxtStrategyActionExecutor`：可作为下单执行器被 TradeActionConsumer 调用
- `MarketDataEngine`：行情源（需扇出）

---

## 11. 额外建议
- 开仓/平仓建议支持幂等（client_order_id）
- 高频行情建议以 `IsBarClose=false` 做“快照更新”，以 `IsBarClose=true` 做“确认触发”
- 建议引入风险级别（如单策略最大亏损/单日最大亏损）

---

## 12. PositionRiskEngine 触发算法与边界条件清单

本节给出**完整触发算法**（含伪代码）与**边界条件实现清单**，用于实现“未平仓风险控制 + 移动止盈止损 + ccxt 平仓”的稳定闭环。

### 12.1 输入与依赖
- **PositionSnapshot**：仓位快照（来自内存缓存或 DB）
- **MarketSnapshot**：行情快照（last/high/low + 时间）
- **RiskConfig**：TP/SL/Trailing 参数（优先使用仓位级）
- **TimePolicy**：触发确认策略（OnBarClose / OnBarUpdate）

### 12.2 触发策略与行情取值
**建议默认策略**
- `OnBarUpdate`：用于更新 trailing 的 `max_favorable_price` 与预警
- `OnBarClose`：用于**最终触发平仓**（更稳定，避免瞬时刺穿）

**行情取值优先级**
- `high/low` 用于触发判断（TP/SL/Trailing）
- `last` 用于更新 `max_favorable_price`
- 若 `high/low` 缺失，则退化为 `last`

### 12.3 风控价位准备规则
**建议：开仓时即固化止盈/止损价**（避免运行时反复计算导致漂移）

若仓位未存止盈/止损价，则按策略配置补算：
**Long**
- `tp = entry * (1 + takeProfitPct)`
- `sl = entry * (1 - stopLossPct)`

**Short**
- `tp = entry * (1 - takeProfitPct)`
- `sl = entry * (1 + stopLossPct)`

**移动止盈（Trailing）默认值**
- `activation_price`：若未存，则用 `entry * (1 ± activationPct)` 计算
- `drawdown_pct`：若无配置，使用默认值（建议 0.01~0.03）

### 12.4 触发算法（伪代码）
```text
function EvaluatePosition(position, market, mode):
  if position.status != Open:
     return
  if market is stale or invalid:
     return

  // 1) 基础触发判断
  tpHit = hitTakeProfit(position, market)
  slHit = hitStopLoss(position, market)

  // 2) Trailing 更新与触发
  trailingHit = false
  if position.trailing_enabled:
     if not activated:
        if activation condition met:
           activate trailing
           update max_favorable_price
           compute trailing_stop_price
           log TrailingActivated
     else:
        update max_favorable_price
        recompute trailing_stop_price
        trailingHit = hitTrailingStop(position, market)
        log TrailingUpdated (可采样)

  // 3) 触发优先级
  trigger = resolvePriority(slHit, trailingHit, tpHit)

  // 4) 触发执行策略
  if trigger:
     if mode == OnBarClose or market.isBarClose:
        enqueue close order
        mark position Closing
        log event
     else:
        mark pending trigger (内存层)  // 等待 bar close 确认
```

### 12.5 Trailing 计算规则（Long/Short）
**Long**
- `max_favorable_price = max(max_favorable_price, high/last)`
- `trailing_stop_price = max_favorable_price * (1 - drawdown_pct)`
- `trailingHit = low <= trailing_stop_price`

**Short**
- `max_favorable_price = min(max_favorable_price, low/last)`
- `trailing_stop_price = max_favorable_price * (1 + drawdown_pct)`
- `trailingHit = high >= trailing_stop_price`

### 12.6 触发优先级与冲突处理
同一根 K 线内多触发时：
1. **StopLoss > TrailingStop > TakeProfit**（默认保守）
2. 可通过配置调整优先级
3. 若需要“真实时间顺序”，必须接入更高频行情（Tick/1s）

### 12.7 幂等、并发与一致性
- **幂等要求**：同一仓位只允许一个有效 close 订单
- **实现建议**：
  - DB 行锁 `SELECT ... FOR UPDATE` 锁住仓位
  - 检查 `status == Open` 且 `close_order_id IS NULL`
  - 先更新 `status=Closing` 再下单，避免重复触发
- **并发控制**：同一仓位评估串行化（可用 in-memory lock + DB 锁）

### 12.8 边界条件实现清单（必须覆盖）

**A. 行情异常**
- `MarketSnapshot` 时间戳过旧（> N 秒） → 跳过
- `high/low/last` 为 0/负值/NaN → 跳过
- 行情跳空（gap） → 允许直接触发止损/止盈

**B. 仓位异常**
- `status != Open` → 跳过
- `qty <= 0` → 标记 Failed/Closed 并记录事件
- `entry_price <= 0` → 跳过 + 事件

**C. 风控参数异常**
- `tp/sl` 为空 → 跳过对应判断
- 方向冲突：
  - Long：`tp <= entry` 或 `sl >= entry`
  - Short：`tp >= entry` 或 `sl <= entry`
- `drawdown_pct <= 0` 或过大（> 0.5）→ 禁用或回退默认值

**D. 多触发冲突**
- `tpHit` 与 `slHit` 同时发生 → 选 StopLoss
- `trailingHit` 与 `slHit` 同时发生 → 选 StopLoss

**E. 平仓重复触发**
- `status == Closing` → 忽略
- 已有 `close_order_id` → 忽略

**F. 部分成交**
- 平仓单部分成交：保持 `Closing`，直到 Filled
- 未完成前禁止新开仓（需结合 OpenConflictPolicy）

**G. 反向开仓冲突**
- 若策略同时触发反向信号 → 先平后开（Reverse）
- 平仓未完成前禁止新方向建仓

**H. 人工干预**
- 手动平仓优先于自动触发
- 手动修改 TP/SL/Trailing 后需立即刷新缓存

**I. 交易所回报异常**
- ccxt 下单异常 → 记录失败事件并回退状态
- 交易所拒单 → 可配置重试次数或人工介入

### 12.9 实现建议（落地细节）
- `last_price` 与 `last_check_at` 每次检查更新，但 DB 写入可降采样
- `TrailingUpdated` 事件建议采样写库（例如每 30s 或价格变动超过阈值）
- 平仓统一使用 `reduceOnly + market`，避免风控触发错单
- 触发原因写入 `close_reason` + `strategy_position_event`

---

> 该文档为框架级设计稿，可作为后续拆解实现的基线。













