# 策略条件检测框架改造方案（积木化）

本文档基于**当前代码实现**与对话目标，给出条件检测框架的可行性评估与改造路线。重点是让“收敛/扩散、布林带距离、比例持续扩大/缩小”等高阶概念能通过少量原语组合表达。

---

## 1. 现状复盘（基于代码）

### 1.1 条件评估入口
- 条件执行：`SeverTest/Modules/StrategyEngine/Application/ConditionEvaluator.cs`
- 方法注册与语义：`SeverTest/Modules/StrategyEngine/Domain/ConditionMethodRegistry.cs`
- 取值解析：`SeverTest/Modules/StrategyEngine/Application/IndicatorValueResolver.cs`

### 1.2 当前支持的核心能力
- 条件方法：比较（`GreaterThan/GreaterThanOrEqual/LessThan/LessThanOrEqual/Equal/NotEqual`）、交叉（`CrossUp/CrossOver/CrossDown/CrossUnder/CrossAny`）、区间（`Between/Outside`）、持续（`Rising/Falling/AboveFor/BelowFor`）、变化（`ROC/Slope`）、通道（`TouchUpper/TouchLower/BreakoutUp/BreakoutDown`）、统计（`ZScore/StdDevGreater/StdDevLess`）、带宽（`BandwidthExpand/BandwidthContract`）。
- 值来源：`Field/Indicator/Const(Number/Constant)`，支持 `OffsetRange` 与 `CalcMode=OnBarClose`。
- 指标能力：`IndicatorEngine` + `TA-Lib`，支持多输出指标（`Output` 指定）。
- 缓存：条件结果按 `ConditionKey + CandleTimestamp` 缓存（`ConditionCacheService`）。

### 1.3 当前限制点
- 已补充 `TryResolveValue/TryResolveValues`，仍缺少通用“公式/算子”值积木（无法直接表达 `A-B`、`A/B`、`(A-mean)/std` 等）。
- 条件方法已扩展到区间/持续/变化率/统计/带宽，但仍可继续补全更复杂组合（如更丰富的区间语义与回归类判定）。

---

## 2. 可行性结论

**结论：可行。**  
当前框架的核心（条件注册表 + 值解析器 + 指标引擎 + 条件缓存）是可扩展的。  
只需新增少量“取值能力”和“条件方法”即可覆盖大部分检测类型。

关键可行性依据：
- 条件方法集中在 `ConditionMethodRegistry`，新增方法风险可控。
- 指标引擎支持任意 TA-Lib 指标，可复用完成通道、波动率、趋势等“值积木”。
- `StrategyMethod.Param` 已进入 Key 计算，适合承载窗口长度/阈值。

主要改动点：
1) 扩展取值接口支持单值/多值。  
2) 新增条件方法（区间、持续、变化率、统计、通道类）。  
3) 引入“值运算积木”（公式/算子）或以“方法内计算”过渡。

---

## 3. 目标与非目标

### 3.1 改造目标
- 以“少量原语 + 组合”覆盖 80% 以上策略条件需求。
- 保持现有策略 JSON 兼容，不破坏老策略运行。
- 具备可控性：lookback、offset、OnBarClose、NotReady 规则明确。

### 3.2 非目标（本期不强制）
- 复杂图形识别、形态识别库的全量接入。
- 全量 Pine Script 语法级兼容。

---

## 4. 积木化分层设计（建议）

### 4.1 值积木（Value Blocks，输出 Series<double>）
1) **数据源**
   - OHLCV、派生价（HL2/HLC3/OHLC4/OC2/HLCC4）
   - 指标输出（TA-Lib）
   - 常量

2) **基础运算（建议新增）**
   - Add/Sub/Mul/Div
   - Abs/Min/Max/Clamp
   - Log/Exp/Sqrt/Pow

3) **窗口统计（建议新增）**
   - SMA/EMA/StdDev/Highest/Lowest/ATR
   - ZScore、LinRegSlope（可选）

4) **通道/边界**
   - Bollinger / Keltner / Donchian

### 4.2 条件积木（Condition Blocks，输出 bool）
1) 比较类：GT/GTE/LT/LTE/EQ/NEQ  
2) 交叉类：CrossOver/CrossUnder/CrossAny  
3) 区间类：Between/Outside/TouchUpper/TouchLower/BreakoutUp/BreakoutDown  
4) 持续性：Rising/Falling/AboveFor/BelowFor  
5) 变化率：Diff/ROC/Slope  
6) 统计类：ZScore 超阈值、StdDevGreater/StdDevLess  

### 4.3 组合逻辑
条件组/容器的 `MinPass` 本质支持 AND/OR 门控，保留现有结构即可。

---

## 5. 新增条件类型建议清单（示例）

以下命名均为建议，确保与现有 `Method` 兼容：

| 分类 | Method | 说明 | Args | Param |
| --- | --- | --- | --- | --- |
| 比较 | NotEqual | A != B | A,B | - |
| 区间 | Between | low <= x <= high | x,low,high | 若缺少用 Param 补 |
| 区间 | Outside | x < low 或 x > high | x,low,high | 同上 |
| 持续 | Rising | 连续 N 根上升 | x | N |
| 持续 | Falling | 连续 N 根下降 | x | N |
| 持续 | AboveFor | 连续 N 根 x > level | x,level | N |
| 变化 | ROC | (x/x[n])-1 > k | x,threshold | N |
| 变化 | Slope | 线性斜率 > k | x,threshold | N |
| 通道 | TouchUpper | High/Close 触碰上轨 | price,upper | - |
| 通道 | TouchLower | Low/Close 触碰下轨 | price,lower | - |
| 通道 | BreakoutUp | 收盘突破上轨 | close,upper | - |
| 通道 | BreakoutDown | 收盘突破下轨 | close,lower | - |
| 统计 | ZScore | z > k / z < k | x,threshold | N |
| 统计 | StdDevGreater | 标准差大于阈值 | x,threshold | N |
| 统计 | StdDevLess | 标准差小于阈值 | x,threshold | N |
| 波动 | BandwidthExpand | 带宽上升/扩张 | upper,lower,middle | N |
| 波动 | BandwidthContract | 带宽下降/收敛 | upper,lower,middle | N |

> 说明：若不新增“值运算积木”，可先把 `bandwidth`、`zscore` 等在方法内临时计算；后续再抽象成值积木。

---

## 6. 参数/取值约定建议

### 6.1 Args 与 Param 规则
- `args`：主要值引用（Field / Indicator / Const），用于左右值或多参数条件。
- `param`：辅助参数数组（如窗口长度 N、阈值），可与 `args` 同时存在。
- 兼容规则（旧配置）：当 `args` 不足时，允许使用 `param` 作为常量补足。

### 6.2 Offset / Lookback 规则
- `offset=0` 表示当前 K；`offset=1` 表示前一根。
- 新增“持续/变化率”类条件时，需要明确 `N`（窗口长度）并计算所需 `MaxOffset`。
- 指标请求的 `MaxOffset` 必须 ≥ 方法所需的最大偏移。

### 6.3 NotReady 规则
建议明确三值逻辑的策略：
- **推荐**：NotReady 直接返回 false，并记录原因（缺历史/指标未就绪）。
- 若未来需要“严格阻断”，可引入 `ConditionResultState`（Success/Fail/NotReady）。

---

## 7. 改造步骤（建议按阶段推进）

### 阶段 1：扩展取值能力（基础）
- **改造点**：`IStrategyValueResolver`
  - 新增 `TryResolveValue(StrategyValueRef, offset)` 与 `TryResolveValues(List<StrategyValueRef>)`
  - 保留 `TryResolvePair` 以兼容旧逻辑
- **实现位置**：`IndicatorValueResolver.cs`
- **目的**：支持“单序列 + 多偏移”与“多参条件”。

### 阶段 2：扩展条件方法
在 `ConditionMethodRegistry.cs` 中新增方法：
`NotEqual/Between/Outside/Rising/Falling/AboveFor/BelowFor/ROC/Slope/TouchUpper/TouchLower/BreakoutUp/BreakoutDown/StdDevGreater/StdDevLess/ZScore`  
并补齐方法日志与错误提示。

### 阶段 3：值运算积木（可选但推荐）
新增 `RefType=Expr`（或独立结构体），支持：
`Add/Sub/Mul/Div/Abs/Min/Max/Clamp`  
用于表达 `A-B`、`A/B` 等常见派生值，减少“方法内计算”的复杂度。

### 阶段 4：文档与前端联动
- 更新 `StrategyEngine/功能说明.md` 条件清单。
- 更新前端条件下拉选项与参数提示。
- 补充“条件 DSL 示例”文档。

---

## 8. 示例表达（如何组合）

### 8.1 收敛/扩散
1) 先构造 bandWidth = (upper - lower) / middle  
2) 条件：`BandwidthContract(bandWidth, N)` 或 `bandWidth < k`

### 8.2 距离布林带上轨
1) distUpper = (upper - close) / (upper - middle)  
2) 条件：`distUpper < x`

### 8.3 比例持续扩大/缩小
1) r = A / B  
2) 条件：`Rising(r, N)` 或 `Falling(r, N)`

---

## 9. 测试与验证建议
- 单元测试覆盖：每个新增 Method 至少 3 组边界样例。
- 指标联动：确保 `MaxOffset` 能满足 lookback，并与 `OnBarClose` 时序一致。
- 历史不足：验证 NotReady 处理与日志提示。
- 性能：在策略数较多时验证 `ConditionCache` 与指标预热是否足够。

---

## 10. 兼容性注意事项
- `CrossOver` 作为 `CrossUp` 的别名继续保留。
- 旧策略 JSON 不变，新字段新增需保持可选。
- Method 名称建议统一 PascalCase，避免大小写不一致导致识别失败。

---

## 11. 变更记录
- 2026-02-03：修复前端条件预览函数初始化顺序，避免保存条件后触发运行时错误。
- 2026-02-03：条件编辑弹窗新增“条件类型 → 条件方法”分层选择，按模板隐藏不必要参数项。
