# 策略运行前检查系统

## 目标
- 在策略切换为运行/暂停开新仓前，统一完成交易所侧的关键校验。
- 通过可扩展的检查链设计，方便后续新增风控规则。
- 记录每次检查的结果与失败原因，便于追溯。

## 触发时机
- 接口：`PATCH /api/strategy/instances/{id}/state`
- 当状态为 `running` 或 `paused_open_position` 时执行检查链。

## 检查流程（当前版本）
按顺序执行，遇到阻断项直接返回错误：
1) 交易所 API 绑定校验  
2) 仓位模式校验（全仓/逐仓）  
3) 可用余额与保证金估算校验（U 本位）

> 其中 API 校验是硬性前置条件；仓位模式与余额校验目前只在 `running` 状态要求通过。

## 结构设计
- 检查上下文：`StrategyRunCheckContext`
- 检查接口：`IStrategyRunCheck`
- 检查服务：`StrategyRunCheckService`
- 单个检查返回 `StrategyRunCheckItem`，最终汇总为 `StrategyRunCheckResult`

目录位置：
- `SeverTest/Services/StrategyRunCheck/`

## 当前检查项
1) API 校验  
   - 文件：`SeverTest/Services/StrategyRunCheck/Checks/ApiKeyRunCheck.cs`
   - 逻辑：验证策略绑定的 API Key 是否存在。

2) 仓位模式校验  
   - 文件：`SeverTest/Services/StrategyRunCheck/Checks/PositionModeRunCheck.cs`
   - 逻辑：调用交易所接口获取账户仓位模式，与策略配置中的 `positionMode` 比对。
   - 期望值：`Cross`（全仓）/ `Isolated`（逐仓）

3) 余额校验  
   - 文件：`SeverTest/Services/StrategyRunCheck/Checks/BalanceRunCheck.cs`
   - 逻辑：读取 U 本位可用余额，并用 `orderQty * price / leverage` 估算最低保证金。

## 日志记录
检查结果写入表：`strategy_run_check_log`
- 成功/失败都会写入
- 失败原因会写入 `reason` 与 `detail_json`

### 表结构（已在数据库创建）
```
strategy_run_check_log
- id BIGINT PK
- uid BIGINT
- us_id BIGINT
- state VARCHAR(32)
- exchange VARCHAR(32)
- symbol VARCHAR(64)
- success TINYINT(1)
- reason VARCHAR(255)
- detail_json JSON
- created_at DATETIME
```

### 建表 SQL
```
CREATE TABLE IF NOT EXISTS strategy_run_check_log (
  id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  uid BIGINT NOT NULL,
  us_id BIGINT NOT NULL,
  state VARCHAR(32) NOT NULL,
  exchange VARCHAR(32) NOT NULL,
  symbol VARCHAR(64) NOT NULL,
  success TINYINT(1) NOT NULL DEFAULT 0,
  reason VARCHAR(255) NOT NULL,
  detail_json JSON NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_strategy_run_check_uid (uid),
  INDEX idx_strategy_run_check_usid (us_id),
  INDEX idx_strategy_run_check_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 关键入口
执行位置：
- `SeverTest/Controllers/StrategyController.cs`
  - `UpdateInstanceState` 中在写入状态前运行检查链
  - 失败会阻断运行并返回具体提示

## 未来扩展方式
新增检查只需：
1) 实现 `IStrategyRunCheck`
2) 在 `Program.cs` 注册为 `IStrategyRunCheck`
3) 在 `StrategyRunCheckContext` 增补需要的上下文字段

示例扩展方向：
- 检查当前持仓占用保证金比例
- 检查策略最大持仓限制
- 检查账户风险等级或白名单状态

## 注意事项
- 检查每次切换运行状态都会实时调用交易所。
- 若交易所接口无法返回仓位模式/余额，检查会失败并提示。
