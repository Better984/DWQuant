# 前后端协议不一致问题修复报告

## 问题发现时间
2026-02-01

## 问题概述

前后端 WebSocket 协议存在不一致，导致前端发送的请求无法被后端正确解析，后端发送的响应也无法被前端正确处理。

## 问题详情

### 1. 请求字段不一致

**前端发送格式**（修复前）：
```typescript
{
  type: "market.subscribe",
  reqId: "req-123",
  ts: 1700000000000,
  payload: { symbols: ["BTC/USDT"] }  // ❌ 使用 payload
}
```

**后端期望格式**：
```csharp
{
  type: "market.subscribe",
  reqId: "req-123",
  ts: 1700000000000,
  data: { symbols: ["BTC/USDT"] }  // ✅ 期望 data
}
```

**影响**：前端发送的 `payload` 字段被后端忽略，导致 `envelope.Data` 为 `null`，所有 WebSocket 请求无法正确解析。

### 2. 响应字段不一致

**后端发送格式**：
```csharp
{
  type: "market.subscribe.ack",
  reqId: "req-123",
  ts: 1700000000000,
  code: 0,
  msg: "ok",
  data: { success: true, symbols: [...] }  // ✅ 使用 data
}
```

**前端期望格式**（修复前）：
```typescript
{
  type: "market.subscribe.ack",
  reqId: "req-123",
  ts: 1700000000000,
  payload: { success: true, symbols: [...] }  // ❌ 期望 payload
}
```

**影响**：后端发送的 `data` 字段被前端忽略，前端无法正确读取响应数据。

### 3. 错误响应格式不一致

**后端发送格式**：
```csharp
{
  type: "error",
  reqId: "req-123",
  ts: 1700000000000,
  code: 2000,  // ✅ 数字错误码
  msg: "未授权",
  data: null
}
```

**前端处理格式**（修复前）：
```typescript
{
  type: "error",
  err: { code: "unauthorized" }  // ❌ 期望字符串错误码
}
```

**影响**：前端无法正确识别和处理错误响应。

## 修复内容

### 1. 修复前端类型定义

**文件**：`Client/src/network/types.ts`

**修改**：
- 将 `payload` 字段改为 `data` 字段
- 添加 `code`、`msg`、`traceId` 字段以匹配后端协议
- 保留 `err` 字段以兼容旧代码（但优先使用 `code`/`msg`）

```typescript
export type WsEnvelope<T = unknown> = {
  type: string;
  reqId?: string | null;
  ts: number;
  code?: number;        // ✅ 新增
  msg?: string | null;   // ✅ 新增
  data?: T | null;       // ✅ 从 payload 改为 data
  traceId?: string | null; // ✅ 新增
  err?: WsError | null;  // 保留以兼容
};
```

### 2. 修复前端发送逻辑

**文件**：`Client/src/network/wsClient.ts`

**修改**：
- 将发送消息时的 `payload` 字段改为 `data` 字段

```typescript
const envelope: WsEnvelope = {
  type,
  reqId: reqId ?? null,
  ts: Date.now(),
  data: payload ?? null,  // ✅ 从 payload 改为 data
};
```

### 3. 修复前端接收逻辑

**文件**：`Client/src/network/marketStream.ts`

**修改**：
- 将处理消息时的 `message.payload` 改为 `message.data`

```typescript
function handleTick(message: WsEnvelope<unknown>): void {
  const ticks = parseTicks(message.data);  // ✅ 从 payload 改为 data
  // ...
}
```

### 4. 修复错误处理逻辑

**文件**：`Client/src/network/wsClient.ts`

**修改**：
- 将错误检查从 `message.err?.code` 改为 `message.code`
- 使用数字错误码（2000/2001/2002）而不是字符串

```typescript
if (message.type === "error") {
  const code = message.code;  // ✅ 使用 code 字段
  if (code === 2000 || code === 2001 || code === 2002) {  // ✅ 数字错误码
    clearToken();
    notifyAuthExpired();
    return;
  }
}
```

### 5. 修复文档不一致

**文件**：`SeverTest/Document/协议请求分析与设计建议.md`

**修改**：
- 将示例中的 `payload` 改为 `data`
- 补充完整的协议字段（`ts`、`code`、`msg`）

## 协议规范（修复后）

### 请求格式（HTTP / WebSocket）

```json
{
  "type": "string",
  "reqId": "string",
  "ts": 1700000000000,
  "data": {}
}
```

### 响应格式（HTTP / WebSocket）

```json
{
  "type": "string",
  "reqId": "string",
  "ts": 1700000000000,
  "code": 0,
  "msg": "ok",
  "data": {},
  "traceId": "string"
}
```

### 错误响应格式

```json
{
  "type": "error",
  "reqId": "string",
  "ts": 1700000000000,
  "code": 2000,
  "msg": "未授权",
  "data": null,
  "traceId": "string"
}
```

## 错误码规范

根据 `ProtocolErrorCodes.cs`：

- **1xxx**：参数/格式错误
  - 1000 InvalidRequest（通用参数错误）
  - 1001 MissingField（缺少字段）
  - 1002 InvalidFormat（格式错误）
  - 1003 OutOfRange（超出限制）
  - 1004 Unsupported（不支持）

- **2xxx**：鉴权/权限错误
  - 2000 Unauthorized（未授权）
  - 2001 TokenInvalid（Token 无效）
  - 2002 Forbidden（无权限）

- **3xxx**：业务错误
  - 3000 NotFound（未找到）
  - 3001 Conflict（冲突）
  - 3003 LimitExceeded（数量上限）
  - 3004 RateLimited（触发限流）

- **5xxx**：系统/依赖错误
  - 5000 InternalError（系统异常）
  - 5003 ServiceUnavailable（服务不可用）

## 验证建议

1. **测试 WebSocket 连接**：验证连接建立是否正常
2. **测试订阅功能**：验证 `market.subscribe` 请求是否能正确解析
3. **测试推送消息**：验证 `mkt.tick` 推送消息是否能正确接收
4. **测试错误处理**：验证错误响应是否能正确识别和处理
5. **测试心跳**：验证 `ping`/`pong` 是否正常工作

## 相关文件

- `Client/src/network/types.ts` - 类型定义
- `Client/src/network/wsClient.ts` - WebSocket 客户端
- `Client/src/network/marketStream.ts` - 行情订阅处理
- `SeverTest/Modules/Shared/Protocol/ProtocolEnvelope.cs` - 后端协议定义
- `SeverTest/Modules/WebSockets/Application/WebSocketHandler.cs` - WebSocket 处理器
- `SeverTest/Document/NetworkProtocol/README.md` - 协议文档

## 总结

本次修复统一了前后端协议格式，确保：
1. ✅ 前端发送的请求使用 `data` 字段，后端能正确解析
2. ✅ 后端发送的响应使用 `data` 字段，前端能正确读取
3. ✅ 错误响应使用数字错误码（`code`），前端能正确识别
4. ✅ 文档示例与实际代码保持一致

修复后，前后端协议完全对齐，WebSocket 通信应能正常工作。
