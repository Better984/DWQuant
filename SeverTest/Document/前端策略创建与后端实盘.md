# 前端策略创建与后端实盘

> 目的：说明前端“创建策略”的配置流程，以及后端实盘运行的实际链路（以当前代码实现为准）。

---

## 一、前端创建策略流程（Strategy Editor）

### 1) 入口与整体结构

- 入口在策略模块页签“创建策略”，用户点击自定义创建后打开编辑流程。
- 编辑流程由 `StrategyEditorFlow` 统一编排。
- `StrategyEditorShell` 仅提供头部/主体/底部布局与按钮（关闭/生成配置），本身不含业务状态。

涉及文件：
- `Client/src/components/StrategyModule.tsx`
- `Client/src/components/StrategyEditorFlow.tsx`
- `Client/src/components/StrategyEditorShell.tsx`

### 2) 指标选择与生成

- 点击“新增指标”打开指标生成器，载入 `talib_indicators_config.json`（当前为 160 项 TA 指标，前后端同源配置）。
- 指标生成后会形成 `refType: "Indicator"` 的配置（包含 timeframe / input / params / output / offsetRange / calcMode）。
- 生成的指标会被加入“已选指标”列表，供条件编辑时引用。
- 图表端技术指标（KLine）使用 `talib-web` + `klinecharts.registerIndicator` 动态注册：
  - 启动时读取 `talib_indicators_config.json` 与 `talib_web_api_meta.json`
  - 自动完成后端 `code/method` 到 talib-web 函数映射
  - 统一注册为 `ta_****`（例如 `ta_MACD`），并根据输出 hint 自动选择 line/bar/circle 绘制
  - 支持全量 160 项配置指标（主图/副图按分组自动归类）
  - 指标参数编辑弹窗按元数据驱动：支持 `Integer/Double/MAType(enum)` 参数类型
  - 指标输入源编辑支持 `Open/High/Low/Close/Volume/HL2/HLC3/OHLC4/OC2/HLCC4`，并通过 `extendData.taInputMap` 注入图表计算
  - 图表侧参数与输入源约束与后端 `IndicatorKey(input/params/output/calcMode)` 一致，避免“前端可配但后端无效”
  - 图表交互改为“独立指标选择弹窗”：支持主/副图筛选、分类筛选、关键字搜索和副图一键关闭
  - 副图指标选择改为“多选叠加”，新增副图时不再替换已有副图
  - 本地魔改 `klinecharts` 的跨设备同步与 `dist` 构建流程，见 `SeverTest/Document/KLineCharts本地源码同步指南.md`

涉及文件：
- `Client/src/components/IndicatorGeneratorSelector.tsx`
- `Client/public/talib_indicators_config.json`
- `Client/public/talib_web_api_meta.json`
- `SeverTest/Config/talib_indicators_config.json`
- `Client/src/components/StrategyIndicatorPanel.tsx`
- `Client/src/lib/talibInit.ts`
- `Client/src/lib/talibIndicatorAdapter.ts`
- `Client/src/lib/registerTalibIndicators.ts`

### 3) 条件容器与条件组

- 默认 4 个条件容器：开多 / 开空 / 平多 / 平空。
- 每个容器最多 3 个条件组；每组最多 6 个条件判断。
- 条件支持：启用/必需、比较/交叉/区间/持续/统计等方法，支持多参数与窗口长度（N）等附加参数。
- 取值支持：左右值/第三参数可为指标字段或数值常量，参数字段通过 `param` 传递（如窗口长度 N）。
- 条件编辑弹窗改为“先选类型再选条件”，并按模板仅展示必要参数，减少新手困惑。

涉及文件：
- `Client/src/components/StrategyEditorFlow.tsx`
- `Client/src/components/ConditionContainerList.tsx`
- `Client/src/components/ConditionEditorDialog.tsx`

### 4) 交易规则配置与生成 JSON

- 点击“生成配置”打开预览弹窗：可在“条件概览”和 JSON 之间切换。
- 交易规则配置内容包括：交易所、交易对、周期、单次开仓数量、最大持仓、杠杆、止盈/止损/移动止盈。
- 运行时间配置：支持模板多选（如 A 股/美股），模板由服务端提供并带唯一模板 ID；自定义不交易/交易时段（自定义按小时精度）。
- 模板支持分钟级时间段（例如 09:30），并可挂载交易日历用于节假日/异常交易时段。
- 运行时间模板与时区由接口 `POST /api/strategy/runtime/templates` 获取（协议类型：`strategy.runtime.template.list`）。
- 默认策略：非运行时间仅禁止开仓，允许平仓/风控（可通过 `outOfSessionPolicy` 调整）。
- 交易规则配置区域随内容自适应，弹窗主体负责滚动；切换步骤会自动回到顶部。
- 交易规则步骤切换仅通过“下一步/上一步”按钮，滚轮不再自动切换步骤。
- 移动止盈止损参数在启用后显示，包含触发收益阈值与回撤触发比例。
- 最终生成 `StrategyConfig`：
  - `trade`: 交易规则
  - `logic`: 逻辑分支（entry/exit, long/short）
  - `runtime`: 运行时间配置（模板仅保存模板 ID 列表）

涉及文件：
- `Client/src/components/StrategyConfigDialog.tsx`
- `Client/src/components/TradeConfigForm.tsx`
- `Client/src/components/StrategyRuntimeConfigForm.tsx`
- `Client/src/components/StrategyModule.types.ts`

### 5) 提交与保存

- 前端调用 `POST /api/strategy/create`，提交 name/description/aliasName/configJson。
- 成功后触发提示并刷新策略列表。

涉及文件：
- `Client/src/components/StrategyModule.tsx`
- `SeverTest/Modules/StrategyManagement/Controllers/StrategyController.cs`

---

## 二、后端实盘运行链路（Server Runtime）

### 1) 策略创建入库

`POST /api/strategy/create`：
- 新建 `strategy_def`
- 新建 `strategy_version`（version_no=1）
- 新建 `user_strategy`（state=completed, visibility=private）
- 更新 `strategy_def.latest_version_id`

涉及文件：
- `SeverTest/Modules/StrategyManagement/Controllers/StrategyController.cs`
- `SeverTest/Document/策略系统.md`

### 2) 运行状态切换（关键入口）

`PATCH /api/strategy/instances/{id}/state`：
- state=running / paused_open_position：解析 config_json -> 组装 StrategyDocument -> 加载为运行时策略 -> 注册到 `RealTimeStrategyEngine`
- state=paused / completed：从 `RealTimeStrategyEngine` 移除
- 可选传 `exchangeApiKeyId`：绑定该策略实例使用的交易所 API key
- 未传时会自动回填该交易所最新 API key（updated_at DESC）；无可用 API 时返回错误
- 若 API key 所属交易所与策略配置不一致，会自动创建新版本并同步 `trade.exchange`

涉及文件：
- `SeverTest/Modules/StrategyManagement/Controllers/StrategyController.cs`
- `SeverTest/Modules/StrategyEngine/Application/StrategyJsonLoader.cs`
- `SeverTest/Modules/StrategyEngine/Application/RealTimeStrategyEngine.cs`

### 3) 行情驱动与执行主链路

- `MarketDataEngine` 产出行情任务（MarketDataTask）。
- `StrategyRuntimeHostedService` 启动指标引擎与策略引擎 worker。
- `RealTimeStrategyEngine` 收到行情任务后：
  1) 刷新指标（IndicatorEngine）
  2) 策略运行时间门禁判定（runtime，模板 ID + 日历异常）
  3) 条件判断（ConditionEvaluator + ConditionMethodRegistry）
  4) 触发动作（ActionMethodRegistry -> IStrategyActionExecutor）

涉及文件：
- `SeverTest/Modules/StrategyRuntime/Application/StrategyRuntimeHostedService.cs`
- `SeverTest/Modules/StrategyEngine/Application/RealTimeStrategyEngine.cs`
- `SeverTest/Modules/StrategyEngine/Application/IndicatorEngine.cs`
- `SeverTest/Modules/StrategyEngine/Application/ConditionEvaluator.cs`
- `SeverTest/Modules/StrategyEngine/Domain/ConditionMethodRegistry.cs`
- `SeverTest/Modules/StrategyEngine/Domain/ActionMethodRegistry.cs`

### 4) 下单与持仓落地

- 当前默认执行器为 `QueuedStrategyActionExecutor`，会把 `StrategyActionTask` 入队。
- `TradeActionConsumer` 消费队列，调用 `CcxtOrderExecutor` 市价下单。
- 开仓成功后写入 `strategy_position`。

涉及文件：
- `SeverTest/Modules/StrategyEngine/Application/QueuedStrategyActionExecutor.cs`
- `SeverTest/Modules/StrategyEngine/Application/StrategyActionTaskQueue.cs`
- `SeverTest/Modules/TradingExecution/Application/TradeActionConsumer.cs`
- `SeverTest/Modules/TradingExecution/Infrastructure/CcxtOrderExecutor.cs`
- `SeverTest/Modules/Positions/Infrastructure/StrategyPositionRepository.cs`

### 5) 风控平仓（止盈/止损/移动止盈）

- `PositionRiskEngine` 周期性扫描未平仓位，结合 TP/SL/Trailing 触发平仓。
- 平仓后更新 `strategy_position` 状态。

涉及文件：
- `SeverTest/Modules/Positions/Application/PositionRiskEngine.cs`

---

## 三、当前实现注意点（与策略运行强相关）

1) **Short 分支未启用**
- `exit.short` / `entry.short` 在策略引擎中仍被注释，当前只执行 Long 分支。
- 涉及文件：`SeverTest/Modules/StrategyEngine/Application/RealTimeStrategyEngine.cs`

2) **启动时自动加载 DB 中运行策略**
- `StrategyRuntimeBootstrapHostedService` 启动时加载 `user_strategy` 中 `running/paused_open_position/testing` 的实例并注册到 `RealTimeStrategyEngine`。
- 会尝试自动回填 `exchange_api_key_id`；找不到可用 API key 的策略会跳过加载。
- `StrategyRuntimeHostedService` 仍只负责启动引擎 Worker。
- 运行策略也可通过 `PATCH /api/strategy/instances/{id}/state` 即时更新。
- 涉及文件：`SeverTest/Modules/StrategyRuntime/Application/StrategyRuntimeBootstrapHostedService.cs` `SeverTest/Modules/StrategyRuntime/Application/StrategyRuntimeHostedService.cs`

3) **前端“数值常量比较”与后端解析不完全对齐**
- 前端会生成 `refType: "Const"` 的右值；
- 后端仅识别 `Indicator`，其余走字段解析并回落到 K 线字段默认值。
- 涉及文件：`Client/src/components/StrategyEditorFlow.tsx` `SeverTest/Modules/StrategyEngine/Application/IndicatorValueResolver.cs`

4) **开仓冲突策略未完整落地**
- `TradeActionConsumer` 当前发现已有仓位会直接忽略新开仓；
- `openConflictPolicy` 尚未应用到开仓流程。
- 涉及文件：`SeverTest/Modules/TradingExecution/Application/TradeActionConsumer.cs` `SeverTest/Modules/Shared/Models/Strategy/StrategyModels.cs`

---

## 四、快速对照：前端生成与后端读取的配置结构

前端生成 `StrategyConfig`：
```
{
  "trade": {
    "exchange": "bitget",
    "symbol": "BTC/USDT",
    "timeframeSec": 60,
    "positionMode": "Cross",
    "openConflictPolicy": "GiveUp",
    "sizing": { "orderQty": 0.001, "maxPositionQty": 10, "leverage": 100 },
    "risk": { "takeProfitPct": 0.02, "stopLossPct": 0.01, "trailing": { ... } }
  },
  "logic": {
    "entry": { "long": { ... }, "short": { ... } },
    "exit": { "long": { ... }, "short": { ... } }
  },
  "runtime": {
    "scheduleType": "Template",
    "outOfSessionPolicy": "BlockEntryAllowExit",
    "templateIds": ["cn.a_share.regular"],
    "custom": {
      "mode": "Deny",
      "timezone": "Asia/Shanghai",
      "days": ["sat", "sun"],
      "timeRanges": [
        { "start": "00:00", "end": "00:00" }
      ]
    }
  }
}
```

后端解析并运行：
- `StrategyJsonLoader.ParseConfig()` -> `StrategyConfig`
- `RealTimeStrategyEngine` 使用 `trade + logic` 执行
- 运行时间模板由服务端模板库（数据库）与日历解析得到具体交易时段

涉及文件：
- `SeverTest/Modules/StrategyEngine/Application/StrategyJsonLoader.cs`
- `SeverTest/Modules/StrategyEngine/Application/RealTimeStrategyEngine.cs`

---

## 五、最小可用链路（实际运行所需）

1. 前端创建策略并保存（`/api/strategy/create`）
2. 通过 `PATCH /api/strategy/instances/{id}/state` 设置为 `running`
   - 需绑定交易所 API key（前端选择或后端自动回填）
3. 服务端行情引擎启动并产出 MarketDataTask
4. 策略引擎运行 -> 触发动作 -> 入队 -> 消费者下单

涉及文件：
- `SeverTest/Modules/StrategyManagement/Controllers/StrategyController.cs`
- `SeverTest/Modules/StrategyRuntime/Application/StrategyRuntimeHostedService.cs`
- `SeverTest/Modules/StrategyEngine/Application/RealTimeStrategyEngine.cs`
- `SeverTest/Modules/TradingExecution/Application/TradeActionConsumer.cs`

---

如需补齐：
- 启动时自动加载 running 策略
- 完整 Short 分支执行
- 数值常量解析
- OpenConflictPolicy 落地逻辑

可在此文档基础上继续扩展实现细节。
