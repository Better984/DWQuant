# WebSockets 模块功能说明

## 功能概述
- 管理 WebSocket 连接、鉴权、限流与消息分发。
- 提供健康检查与账户信息更新等消息处理能力。
- 支持分布式踢线与连接管理。
- `KickOld` 策略在 Redis 模式下会先广播跨节点踢线，再本地挤出旧连接，降低多节点并发登录下的连接残留问题。

## 主要入口
- 核心处理：`Application/WebSocketHandler.cs`、`Application/IWsMessageHandler.cs`
- 消息处理器：`Application/Handlers/HealthWsHandler.cs`、`Application/Handlers/AccountProfileUpdateHandler.cs`
- 连接管理：`Infrastructure/RedisConnectionManager.cs`、`Infrastructure/RedisConnectionKickSubscriber.cs`

## 联动关系
- `Accounts`：`Program.cs` 在握手时调用 `AuthTokenService` 校验 token。
- `Accounts`：登录成功后会通过 `AccountSessionKickService` 对同 `userId+system` 的旧连接执行挤线（跨节点广播 + 本地踢线）。
- `MarketStreaming`：订阅/取消订阅消息由 MarketStreaming 的处理器实现。
- `Shared`：统一协议封装、限流与错误码。
- `Controllers/WsHandshakeController`：提供 `/api/ws/handshake/check` HTTP 预校验接口，供前端在真正发起 `/ws` 握手前检查 token 等基础条件，并以协议化错误码返回失败原因。
