# StrategyEngine 模块功能说明

## 功能概述
- 策略核心执行引擎与指标计算能力。
- 条件评估、动作队列与运行日志写入。
- 启动前运行检查（API Key、仓位模式、余额等）。
- 条件检测取值日志：记录指标值、K 线时间与开高低收、固定值等。
- 策略运行时间门禁：支持模板/自定义时间段，控制策略在实盘中的执行窗口。
- 开仓筛选器：仅在开多/开空检测前执行，用于快速过滤不满足条件的策略。
- 运行时间模板由数据库存储，服务端提供模板接口与缓存；策略仅保存模板 ID；模板可挂载交易日历，用于节假日/异常交易时段。

## 条件检测支持
- 比较方法：`GreaterThan`、`GreaterThanOrEqual`、`LessThan`、`LessThanOrEqual`、`Equal`、`NotEqual`。
- 交叉方法：`CrossUp`、`CrossDown`、`CrossAny`（兼容 `CrossOver` / `CrossUnder` 别名）。
- 区间方法：`Between`、`Outside`。
- 持续方法：`Rising`、`Falling`、`AboveFor`、`BelowFor`。
- 变化方法：`ROC`、`Slope`。
- 通道边界：`TouchUpper`、`TouchLower`、`BreakoutUp`、`BreakoutDown`。
- 统计方法：`ZScore`、`StdDevGreater`、`StdDevLess`。
- 带宽趋势：`BandwidthExpand`、`BandwidthContract`。
- 参数来源：
  - `args`：值引用（Field / Indicator / Const），用于左右值或多参数取值。
  - `param`：辅助参数（如窗口长度 N、阈值），与 `args` 可同时存在。
  - 兼容：当 `args` 不足时，仍可使用 `param` 作为常量补足。

## 主要入口
- 引擎与执行：`Application/RealTimeStrategyEngine.cs`、`Application/QueuedStrategyActionExecutor.cs`
- 指标/条件：`Application/IndicatorEngine.cs`、`Application/ConditionEvaluator.cs`
- 条件缓存清理：`Application/ConditionCacheCleanupHostedService.cs`
- 运行检查与日志：`Application/RunChecks/*`、`Application/RunChecks/Checks/ExchangeReadyRunCheck.cs`、`Application/StrategyEngineRunLogWriter.cs`
- 运行时间配置与判定：`Domain/StrategyRuntimeSchedule.cs`、`Application/StrategyRuntimeConfigValidator.cs`
- 运行时间模板与日历：`Infrastructure/StrategyRuntimeTemplateRepository.cs`、`Infrastructure/StrategyRuntimeTemplateStore.cs`

## 配置选项
- `ConditionCacheOptions`：条件缓存清理间隔配置（`ConditionCache:CleanupIntervalSeconds`）

## 联动关系
- `ExchangeApiKeys`：运行检查读取 API Key 状态。
- `MarketStreaming`：获取行情/指标输入数据。
- `TradingExecution`：将策略动作下发到交易执行层。

## 变更记录
- 2026-02-02：修复条件日志中指标 Timeframe 的取值来源，统一从指标请求键读取。
- 2026-02-02：条件检测 K 线日志补充 open/high/low/close，便于排查取值。
- 2026-02-05：运行时间模板改为模板 ID + 服务端日历解析，支持节假日/异常交易时段。
- 2026-02-05：新增策略运行时间门禁，支持模板/自定义时间段控制实盘执行。
- 2026-02-05：运行时间模板改为数据库存储，新增后台管理接口与缓存刷新。
- 2026-02-05：新增开仓筛选器配置与优先判断流程。
