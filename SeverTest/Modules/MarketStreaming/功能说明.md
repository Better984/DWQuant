# MarketStreaming 模块功能说明

## 功能概述
- 行情订阅与推送，提供价格与 K 线的实时流。
- 维护订阅关系并周期广播行情数据。
- 对外提供价格/行情查询接口。
- 行情任务支持多消费者订阅，避免竞争消费导致丢任务。
- 价格订阅服务在交易所初始化失败时会明确失败并中止订阅启动，避免系统进入假就绪。
- 提供 `IsExchangeReady` 用于策略侧检查交易所行情是否就绪。

## 配置选项
- `MarketDataQueryOptions`：实时行情缓存长度与单次拉取上限。
- `RedisKeyOptions`：订阅关系在 Redis 的 Key 前缀。

## 主要入口
- 控制器：`Controllers/PriceController.cs`
- WebSocket 处理器：`Application/MarketSubscribeHandler.cs`、`Application/MarketUnsubscribeHandler.cs`
- 服务：`Application/MarketDataEngine.cs`、`Application/ExchangePriceService.cs`、`Application/MarketTickerBroadcastService.cs`、`Application/KlineCloseListenerService.cs`
- 订阅存储：`Infrastructure/RedisMarketSubscriptionStore.cs`、`Infrastructure/InMemoryMarketSubscriptionStore.cs`

## 联动关系
- `WebSockets`：通过消息处理器对接订阅/取消订阅，并向连接推送行情。
- `MarketData`：为实时 K 线接口提供数据来源。
- `StrategyEngine`/`StrategyRuntime`/`TradingExecution`/`Positions`：提供行情与价格能力。

## 变更记录
- 2026-02-02：修复 1m 收线任务时间戳使用上一根已收线 K 线，避免误取新开盘数据。
