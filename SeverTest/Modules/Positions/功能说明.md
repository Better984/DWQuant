# Positions 模块功能说明

## 功能概述
- 提供仓位查询与状态管理。
- 维护风控配置与风险引擎处理。
- 规划引入价格区间树索引，按价格区间快速筛选止盈/止损/移动止盈候选仓位，减少全量扫描压力。
- 支持仓位平仓与结果回传（含单仓位与按策略一键平仓）。
- 平仓原因记录：ManualSingle/ManualBatch/StopLoss/TakeProfit/TrailingStop。

## 主要入口
- 控制器：`Controllers/PositionsController.cs`
- 服务：`Application/PositionRiskEngine.cs`、`Application/StrategyPositionCloseService.cs`、`Application/PositionRiskConfigStore.cs`、`Application/PositionRiskIndexManager.cs`
- 仓储：`Infrastructure/StrategyPositionRepository.cs`

## 高性能索引（已实现）
- 价格区间树索引：按交易对维度维护多层桶（大/中/小步长），用于在价格区间内快速定位触发仓位。
- 追踪止盈分层索引：包含激活阈值索引、触发阈值索引、下一次更新阈值索引，避免每秒全量更新。
- 价格区间追踪：记录上一轮检查的价格与高低点，确保剧烈波动时覆盖完整区间。

## 联动关系
- `Accounts`：仓位相关接口鉴权。
- `MarketStreaming`：获取行情/价格以评估风险或平仓条件。
- `TradingExecution`：实际下单/平仓执行。
