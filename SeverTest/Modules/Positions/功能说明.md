# Positions 模块功能说明

## 功能概述
- 提供仓位查询与状态管理。
- 维护风控配置与风险引擎处理。
- 规划引入价格区间树索引，按价格区间快速筛选止盈/止损/移动止盈候选仓位，减少全量扫描压力。
- 支持仓位平仓与结果回传（含单仓位与按策略一键平仓）。
- 平仓原因记录：ManualSingle/ManualBatch/StopLoss/TakeProfit/TrailingStop。
- 新增仓位总览聚合能力：一次查询返回指定时间段开仓历史、策略开仓统计、参与版本列表、当前持仓及浮动盈亏。
- 新增开仓版本快照字段 `strategy_position.strategy_version_id`，用于后续精确还原开仓使用版本。
- 新增平仓快照字段：`strategy_position.close_price`、`strategy_position.realized_pnl`，用于统计胜率与已实现盈亏。
- 新增近期总结聚合接口：自动在 1/3/7/30 天窗口中回退，输出开仓次数、胜率、已实现盈亏与当前浮动盈亏。
- 新增近期操作日志接口：聚合开仓/平仓时间线，并合并通知中心的告警消息（Warn/Critical）。
- 提供历史仓位版本回填脚本：将旧数据按开仓时间推断到对应版本，减少历史口径误差。

## 主要入口
- 控制器：`Controllers/PositionsController.cs`
- 服务：`Application/PositionRiskEngine.cs`、`Application/StrategyPositionCloseService.cs`、`Application/PositionRiskConfigStore.cs`、`Application/PositionRiskIndexManager.cs`、`Application/PositionOverviewService.cs`
- 仓储：`Infrastructure/StrategyPositionRepository.cs`

## 对外接口
- `POST /api/positions/list`（`position.list`）：按用户查询仓位。
- `POST /api/positions/by-strategy`（`position.list.by_strategy`）：按策略实例查询仓位。
- `POST /api/positions/overview`（`position.overview`）：仓位总览聚合查询。
- `POST /api/positions/recent-summary`（`position.recent.summary`）：近期总结聚合查询（自动回退 1/3/7/30 天窗口）。
- `POST /api/positions/recent-activity`（`position.recent.activity`）：近期操作日志查询（开仓/平仓 + 告警时间线）。
- `POST /api/positions/close-by-strategy`（`position.close.by_strategy`）：按策略一键平仓。
- `POST /api/positions/close-by-id`（`position.close.by_id`）：单仓位平仓。

## 仓位总览口径说明
- 开仓成功口径：`strategy_position` 成功写入即视为开仓成功。
- 版本来源优先级：`snapshot(仓位快照)` > `inferred(按开仓时间推断版本)` > `pinned(回退当前绑定版本)`。
- 浮动盈亏口径：基于实时行情最新价计算（Long: `(最新价-开仓价)*数量`，Short: `(开仓价-最新价)*数量`）。
- 已实现盈亏口径：优先使用 `realized_pnl`；若历史记录未写入但存在 `close_price`，按 `(close_price-entry_price)*qty`（空头反向）回补计算。
- 胜率口径：统计窗口内 `status='Closed'` 且已实现盈亏 `> 0` 的仓位占比。
- 近期总结回退规则：优先 1 天，若开仓数为 0 则回退到 3/7/30 天；30 天仍为 0 则判定无近期开仓数据。
- 批量平仓写回口径：同一批平仓仓位共用一个 `close_price`（优先订单均价，缺失时回退实时价，再回退组内加权开仓价），并逐仓计算 `realized_pnl`。
- 近期操作日志口径：开仓事件取 `opened_at`，平仓事件取 `closed_at`，告警事件取通知中心入箱时间 `notification_user.created_at`，统一按时间倒序输出。

## 高性能索引（已实现）
- 价格区间树索引：按交易对维度维护多层桶（大/中/小步长），用于在价格区间内快速定位触发仓位。
- 追踪止盈分层索引：包含激活阈值索引、触发阈值索引、下一次更新阈值索引，避免每秒全量更新。
- 价格区间追踪：记录上一轮检查的价格与高低点，确保剧烈波动时覆盖完整区间。
- 仓位查询索引：`idx_uid_status_opened(uid,status,opened_at)`、`idx_uid_version_opened(uid,strategy_version_id,opened_at)`。
- 近期总结轻量查询：窗口统计仅扫描 `strategy_position`，当前浮盈统计使用轻量 open 查询（不做策略维度联表），降低首页请求开销。

## 联动关系
- `Accounts`：仓位相关接口鉴权。
- `MarketStreaming`：获取行情/价格以评估风险或平仓条件。
- `TradingExecution`：实际下单/平仓执行。
- `Notifications`：读取 Warn/Critical 级别通知，补充近期操作日志中的告警项。
