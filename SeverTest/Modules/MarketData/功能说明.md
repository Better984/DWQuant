# MarketData 模块功能说明

## 功能概述
- 提供历史 K 线查询与缓存。
- 支持历史行情同步与下载（后台任务）。
- 提供实时最新 K 线查询入口。
- 缓存多个交易所的多个交易对的合约详情信息。

## 配置选项
- `HistoricalMarketDataOptions`：历史行情同步、预加载与缓存上限。
- `MarketDataQueryOptions`：历史数据拉取批次与单次请求上限。

## 主要入口
- 控制器：`Controllers/MarketDataController.cs`
- 服务：
  - `Application/HistoricalMarketDataSyncService.cs`：历史行情同步服务
  - `Application/HistoricalMarketDataSyncHostedService.cs`：历史行情同步后台服务
  - `Application/BinanceHistoricalDataDownloader.cs`：币安历史数据下载器
  - `Application/ContractDetailsCacheService.cs`：合约详情缓存服务
  - `Application/ContractDetailsCacheHostedService.cs`：合约详情缓存后台服务
- 缓存/仓储：`Application/HistoricalMarketDataCache.cs`、`Infrastructure/HistoricalMarketDataRepository.cs`
- Domain：`Domain/ContractDetails.cs`：合约详情模型

## 合约详情缓存功能
- **功能说明**：缓存多个交易所（Binance、OKX、Bitget）的多个交易对的合约详情信息
- **数据来源**：通过 CCXT 的 `loadMarkets()` 方法获取交易所的 markets 数据
- **缓存内容**：合约符号、基础资产、计价资产、合约类型、精度、限制等信息
- **数据持久化**：
  - 使用数据库表 `contract_details` 存储合约详情
  - 启动时先从数据库读取已缓存的合约详情
  - 然后验证是否和交易所一致，如果不同则更新数据库和内存缓存
  - 每天凌晨 2:00 UTC 重新获取并更新所有交易所的合约详情
- **刷新策略**：
  - 启动时：从数据库加载 → 验证与交易所一致性 → 如有差异则更新
  - 每日刷新：每天凌晨 2:00 UTC 从交易所获取最新数据并更新数据库
- **查询接口**：
  - 获取指定交易所的所有合约：`GetContractsByExchange(ExchangeEnum)`
  - 获取指定交易所和交易对的合约详情：`GetContract(ExchangeEnum, string)`
  - 获取所有交易所的所有合约：`GetAllContracts()`
  - 获取指定交易对在所有交易所的合约详情：`GetContractsBySymbol(string)` 或 `GetContractsBySymbol(SymbolEnum)`
  - 获取缓存统计信息：`GetCacheStats()`
- **数据库表**：`contract_details`（SQL 脚本位于 `Sql/contract_details.sql`）
- **对外接口**：如需对外提供 HTTP 接口，可在 Controllers 中注入 `ContractDetailsCacheService` 并添加相应的 Controller 方法

## 联动关系
- `MarketStreaming`：通过 `MarketDataEngine` 获取实时最新 K 线。
- `Monitoring`：启动监控窗口展示历史行情缓存与下载状态。
- `TradingExecution`：可查询合约详情用于下单时的参数校验。
- HTTP 控制器已启用 `ProtocolJson` 配置，`exchange/timeframe/symbol` 支持字符串枚举入参（大小写不敏感），与 WebSocket 协议保持一致。
