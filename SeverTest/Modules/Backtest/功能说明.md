# Backtest 模块功能说明

## 功能概述
- 提供策略回测入口，基于历史 K 线进行 Bar 驱动模拟。
- 复用指标/条件/动作执行链路，保证与实盘语义一致。
- 支持多标的交集时间轴、固定滑点、固定下单数量、止盈止损、自动反向。
- 支持异步任务队列：用户提交回测后获取 `taskId`，通过 HTTP 轮询或 WebSocket 推送跟踪进度与结果。
- 输出交易明细、权益曲线、事件与统计结果（可裁剪），含高级统计指标。
- 为降低前端解析开销，详细数据以字符串数组返回，前端按需逐条解析展示。
- 支持 Funding Rate（资金费率）模拟，默认值为 0。
- 单任务主循环采用“时间轴串行 + 同时间点多 symbol 并行”模型，在保证时序一致性的前提下提升吞吐。
- 引入回测对象池（启动预热 + 运行时动态扩容），复用主循环热点对象，降低 GC 压力。
- 支持双执行模式：
  - `batch_open_close`：批量开仓检测 + 并行统一平仓（高性能默认）。
  - `timeline`：时间轴串行推进（兼容模式）。

## 模块结构与职责拆分

### Application 层
| 文件 | 职责 |
|---|---|
| `BacktestService.cs` | 回测入口服务，解析策略配置并调用 Runner |
| `BacktestRunner.cs` | 回测总编排器（参数解析、策略实例构建、数据加载、结果汇总） |
| `BacktestMainLoop.cs` | 主循环执行器（指标计算、条件评估、动作执行、风控、收尾强平） |
| `BacktestSymbolRuntime.cs` | 单标的运行时上下文模型（状态、策略、输出容器） |
| `BacktestParameterParser.cs` | 参数校验与解析（标的/时间范围/bar 数量/资金曲线颗粒度） |
| `BacktestDataLoader.cs` | K 线数据加载（三级缓存回退、区间/数量查询、时间线交集） |
| `BacktestStatisticsBuilder.cs` | 统计计算（基础指标 + 高级指标、交易/资金/事件汇总） |
| `BacktestSlippageHelper.cs` | 滑点计算（统一入口，消除重复代码） |
| `BacktestActionExecutor.cs` | 交易动作模拟（开/平仓、止盈止损、Funding Rate 结算） |
| `BacktestMarketDataProvider.cs` | 回测专用行情数据提供器（内存 K 线查询） |
| `BacktestObjectPoolManager.cs` | 回测对象池管理器（热点对象租借/归还、自动扩容） |
| `BacktestObjectPoolWarmupHostedService.cs` | 启动时对象池预热服务（读取配置并初始化池容量） |
| `BacktestProgressPushService.cs` | WebSocket 进度推送服务 |
| `BacktestTaskService.cs` | 异步任务管理（提交、状态查询、取消、限流） |
| `BacktestTaskWorker.cs` | 后台任务处理器（HostedService，轮询队列并发执行） |

### Infrastructure 层
| 文件 | 职责 |
|---|---|
| `BacktestTaskRepository.cs` | 回测任务持久化（`backtest_task` 表 CRUD） |

### Domain 层
| 文件 | 职责 |
|---|---|
| `BacktestModels.cs` | 请求/结果/任务/统计等领域模型 |

### Controllers 层
| 文件 | 职责 |
|---|---|
| `BacktestController.cs` | HTTP API 入口（同步执行 + 异步任务队列） |

## 复用与最小侵入
- 历史 K 线读取优先级（由 `BacktestDataLoader` 统一管理）：
  - 首选：通过 `HistoricalMarketDataCache` 直接从历史行情缓存截取（区间模式与按根数模式均优先命中缓存）；
  - 次选：`IMarketDataProvider`（如 `MarketDataEngine`）读取运行态历史缓存；
  - 兜底：若缓存未命中或数据不足，回退到 `HistoricalMarketDataRepository` 直接读表（表名规则与 MarketData 一致）。
  - 回测日志会输出缓存命中/未命中与未命中原因（`reason`），便于定位是否发生了不必要的读表。
- 指标链路：`IndicatorEngine` / `IndicatorValueResolver`。
- 条件评估：`ConditionEvaluator` / `ConditionMethodRegistry`。
- 运行时间：`StrategyRuntimeSchedule`（支持模板/自定义时间段）。
- 动作执行：`ActionMethodRegistry` + `IStrategyActionExecutor`。
- 合约精度：`ContractDetailsCacheService`（下单数量精度与合约乘数）。

## 关键约束（MVP）
- 成交价：使用 1m K 线收盘价 + 固定滑点（bps）。
- 缺失 K 线：跳过，不补齐。
- 多标的：仅在所有标的都有该时间点才驱动（交集时间轴）。
- 时序执行：外层时间轴严格串行推进；仅对同一时间点内的 symbol 维度做并行计算，避免跨时间乱序。
- 高速模式：先批量收集开仓信号，再统一并行平仓，可显著降低大样本回测耗时。
- 内存优化：主循环 K 线字典、条件评估中间 List、指标任务与策略上下文通过对象池复用，池空时自动扩容。
- 资金模型：固定下单数量（`orderQty`），不做复杂资金管理。
- 不做逐笔撮合/盘口模型。
- 单向持仓：同一标的同时仅允许一个方向的持仓。
- Funding Rate：模拟 8 小时结算周期，根据 K 线周期估算收取次数，默认费率为 0。

## 异步任务队列

### 流程
1. 用户调用 `POST /api/backtest/submit` 提交回测请求，获取 `BacktestTaskSummary`（含 `taskId`）。
2. 任务进入 MySQL `backtest_task` 表，状态为 `queued`。
3. 后台 `BacktestTaskWorker`（HostedService）轮询队列，按并发限制取出任务执行。
4. 前端通过以下方式获取进度/结果：
   - **HTTP 轮询**：`GET /api/backtest/task/{taskId}/status`，返回 `BacktestTaskSummary`。
   - **活跃任务查询**：`GET /api/backtest/tasks/active`，用于页面初始化时判断当前用户是否存在进行中的回测任务。
   - **WebSocket 推送**：任务执行过程中自动推送 `backtest.progress`。
5. 任务完成后，通过 `GET /api/backtest/task/{taskId}/result` 获取完整结果。

### 限流与保护
- **单用户并发**：由 `Backtest:MaxTasksPerUser` 控制（默认 2）。
- **全局队列容量**：由 `Backtest:MaxQueueSize` 控制（默认 20）。
- **全局并发执行**：由 `Backtest:MaxConcurrentTasks` 控制（默认 3）。
- **单任务内部并行度**：由 `Backtest:InnerParallelism` 控制（默认 4，`<=0` 按 CPU 核心数）。
- **单次最大 K 线数**：由 `Backtest:MaxBarCount` 控制（默认 500000）。
- **任务超时**：由 `Backtest:TaskTimeoutMinutes` 控制（默认 10 分钟）。
- **结果保留天数**：由 `Backtest:ResultRetentionDays` 控制（默认 30 天），Worker 每 10 分钟执行一次过期清理。
- 以上配置均通过 `ServerConfigStore` 管理，大部分支持实时生效。

### 任务状态流转
```
queued → running → completed
                 → failed
       → cancelled
```

### 数据持久化
- 回测任务存储在 MySQL `backtest_task` 表，包含：
  - 任务元信息（userId、reqId、exchange、symbols、timeframe、barCount）
  - 进度信息（status、progress、stage、stageName、message）
  - 请求/结果 JSON（request_json、result_json）
  - 时间戳（created_at、started_at、completed_at、updated_at）
- `BacktestTaskWorker` 启动时会自动执行 `EnsureSchemaAsync`，并在提交任务时二次兜底，避免建表时序问题。
- 回测阶段进度会同时写入 `backtest_task`（`progress/stage/stage_name/message`），确保无 WebSocket 连接时 HTTP 轮询仍可获取实时进度。
- 使用 `Newtonsoft.Json` 序列化请求和结果到 JSON 字段。

## 资金曲线输出优化
- 支持按粒度聚合资金曲线：`1m/15m/1h/4h/1d/3d/7d`。
- 聚合逻辑为"按时间桶落点"：每个桶仅保留末尾权益快照，避免每根 K 线都输出导致内存膨胀。
- 每个资金曲线点除累计值外，额外输出区间增量：
  - `periodRealizedPnl`：当前桶内已实现盈亏增量。
  - `periodUnrealizedPnl`：当前桶内未实现盈亏增量。
- 聚合后仍保留确定性：同样输入下，桶对齐与输出顺序固定。

## 回测热路径优化
- 主循环取数改为“预计算序列 key + 按 key 直查”：在进入时间轴前一次性生成 `exchange|symbol|timeframe`，循环内不再重复 `NormalizeExchange/NormalizeTimeframe` 与 key 拼接。
- `BacktestMarketDataProvider` 增加 `TryGetBarBySeriesKey` 快路径，`BacktestSeries` 的时间戳索引构建改为 `TryAdd`，减少字典双查找。
- 批量模式 `BatchIndicatorProvider` 保留参数一致性校验，但改为“先直接比较，失配再归一化回退”，避免每次历史 K 线请求固定多次 Normalize。
- 驱动时间轴抽取由 `Select + Where + ToList` 改为单次 `foreach`，并按 `drivingBars.Count` 预分配容量，降低迭代器与扩容开销。
- `SelectDrivingBars` 在时间范围模式改为二分定位起止索引（基于 K 线升序约定），减少全表扫描。
- `BuildIntersection` 改为首集合直接构建交集基底，后续集合再做交集，减少首轮临时集合开销。
- 统计阶段在 `BuildStats` 内共享一份收益率统计结果，Sharpe/Sortino 不再重复提取收益率序列。

## 前端解析优化
- 交易明细/资金曲线/事件日志均输出关键指标汇总（数量、最大盈利/亏损、时间范围等）。
- 详细列表不直接返回对象数组，改为 JSON 字符串数组，前端滚动/展开时逐条解析。

## 统计口径

### 基础指标
- 总收益 `TotalProfit`：交易明细 PnL 求和（已扣手续费）。
- 总收益率 `TotalReturn`：TotalProfit / 初始资金。
- 最大回撤 `MaxDrawdown`：权益曲线的峰值回撤比例。
- 胜率 `WinRate`：盈利交易数 / 交易总数。
- 交易次数 `TradeCount`。
- 平均盈亏 `AvgProfit`：TotalProfit / TradeCount。
- 盈亏比 `ProfitFactor`：盈利总和 / |亏损总和|。
- 平均盈利 `AvgWin`，平均亏损 `AvgLoss`。

### 高级指标
- 夏普比率 `SharpeRatio`：年化，无风险利率 = 0，基于周期收益率标准差。
- Sortino 比率 `SortinoRatio`：年化，仅考虑下行波动率。
- 年化收益率 `AnnualizedReturn`：按实际回测交易时长折算。
- 最大连续亏损次数 `MaxConsecutiveLosses`。
- 最大连续盈利次数 `MaxConsecutiveWins`。
- 平均持仓时间 `AvgHoldingMs`：每笔交易 (exitTime - entryTime) 的平均值（毫秒）。
- 最大回撤持续时间 `MaxDrawdownDurationMs`：从峰值到恢复（或回测结束）的最长持续时间（毫秒）。
- Calmar 比率 `CalmarRatio`：年化收益率 / 最大回撤。

## Funding Rate（资金费率）
- 请求参数 `fundingRate`（默认 0），表示每 8 小时收取一次的费率。
- `BacktestActionExecutor` 在主循环中按 K 线周期估算结算次数，对活跃持仓扣除/增加资金费用。
- 资金费用累加到 `SymbolState.AccumulatedFunding` 并计入已实现盈亏。
- 默认 fundingRate = 0 时，不产生任何额外费用。

## 服务器配置项
以下配置通过 `ServerConfigStore`（`server_config` 表）管理，定义在 `ServerConfigDefinitions.cs`：

| 配置键 | 类型 | 说明 | 实时生效 |
|---|---|---|---|
| `Backtest:MaxConcurrentTasks` | int | 全局最大并发回测任务数 | 是 |
| `Backtest:InnerParallelism` | int | 单任务主循环每个时间点的 symbol 并行度（`<=0` 按 CPU 核心数） | 是 |
| `Backtest:MaxTasksPerUser` | int | 单用户最大并发回测任务数 | 是 |
| `Backtest:MaxQueueSize` | int | 回测队列最大排队数量 | 是 |
| `Backtest:MaxBarCount` | int | 单次回测最大 K 线数量 | 是 |
| `Backtest:TaskTimeoutMinutes` | int | 单次回测最大执行时间（分钟） | 是 |
| `Backtest:ResultRetentionDays` | int | 回测结果保留天数 | 是 |
| `Backtest:ExecutionModeDefault` | string | 默认执行模式（`batch_open_close`/`timeline`） | 是 |
| `Backtest:BatchCloseParallelism` | int | 批量模式统一平仓并行度（`<=0` 按 CPU 核心数） | 是 |
| `Backtest:BatchCloseCandidateSliceSize` | int | 批量模式单个并行任务处理的平仓候选数量（建议 50~500） | 是 |
| `Backtest:BatchAllowOverlappingPositions` | bool | 批量模式是否允许重叠仓位 | 是 |
| `Backtest:ObjectPool:BarDictionaryPrewarm` | int | 回测对象池：K 线字典预热数量 | 否（需重启） |
| `Backtest:ObjectPool:ConditionResultListPrewarm` | int | 回测对象池：条件结果列表预热数量 | 否（需重启） |
| `Backtest:ObjectPool:StrategyMethodListPrewarm` | int | 回测对象池：条件方法列表预热数量 | 否（需重启） |
| `Backtest:ObjectPool:TimestampSetPrewarm` | int | 回测对象池：时间戳集合预热数量 | 否（需重启） |
| `Backtest:ObjectPool:IndicatorTaskPrewarm` | int | 回测对象池：指标任务预热数量 | 否（需重启） |
| `Backtest:ObjectPool:StrategyContextPrewarm` | int | 回测对象池：策略上下文预热数量 | 否（需重启） |
| `Backtest:WorkerPollingIntervalMs` | int | 任务轮询间隔（毫秒） | 否（需重启） |

默认值在 `appsettings.json` 的 `Backtest` 节点中定义。

## 调试日志
- 回测链路新增性能分析日志，统一前缀：`回测系统Log：`，便于排查耗时瓶颈。
- 日志覆盖参数解析、策略实例构建、主周期/补充周期 K 线加载、交集时间轴、核心执行、仓位汇总与回测完成。
- 回测完成日志会输出分阶段耗时汇总：参数解析、策略构建、主周期加载、交集构建、补充周期、核心执行、收尾阶段。
- 主循环拆分日志包含逻辑执行耗时分解（开仓/平仓及过滤/检查/动作）。
- 批量模式会新增阶段级性能日志：数据准备、开仓检测、平仓检测、权益构建与总耗时，并输出命中率、吞吐和 Top 标的统计。
- 多线程并行阶段会额外输出并行参与信息：线程数、参与核心数、核心列表、线程核心映射（线程ID → 核心ID）。
- 数据加载日志统一中文字段，包含缓存命中/回退原因、请求数量与返回数量，便于定位是否发生不必要的读表。
- 为避免日志本身影响回测性能，逐 K 线的 `Debug` 级细节日志默认关闭。

## 回测实时推送
- 当用户已建立 WebSocket 连接时，回测链路会推送 `backtest.progress`。
- 推送与 HTTP 请求共享 `reqId`，前端按 `reqId` 过滤并展示当前任务阶段。
- 阶段推送覆盖：参数解析、策略构建、K 线加载、交集构建、主循环、仓位汇总、完成/失败。
- 批量模式增强阶段推送：
  - 第一阶段（`batch_open_phase`）实时展示“正在检测开仓”进度，并同步已获取开仓数量；
  - 第一阶段结束明确返回“开仓数量检测完毕，共 N 个仓位”；
  - 第二阶段（`batch_close_phase`）优先检测最近仓位，实时推送平仓进度、胜率、胜负场数；
  - 开仓/平仓阶段按约 0.1 秒节流推送，单标的大样本场景也会持续刷新。
- 仓位汇总阶段支持 0.1 秒节流增量推送：
  - 推送当前已发现仓位数量；
  - 可携带增量仓位详情（测试阶段用于快速预览）；
  - 最终仍以 `backtest.run` 完整响应结果为准。
- 第二阶段可推送最近 100 条仓位预览窗口（`replacePositions=true`），前端应覆盖式展示，便于用户先查看最新结果。
- 若用户无 WebSocket 连接，推送自动跳过，不影响回测主流程。

## 主要入口
- `Application/BacktestService.cs`
- `Application/BacktestRunner.cs`（总编排器）
- `Application/BacktestMainLoop.cs`（主循环执行器）
- `Application/BacktestSymbolRuntime.cs`（运行时上下文）
- `Application/BacktestTaskService.cs`（异步任务管理）
- `Application/BacktestTaskWorker.cs`（后台任务处理器）
- `Controllers/BacktestController.cs`
- `Domain/BacktestModels.cs`
- `Infrastructure/BacktestTaskRepository.cs`

## 联动关系
- `MarketData`：历史行情缓存截取 + 历史行情表读取（通过 `BacktestDataLoader`）。
- `StrategyEngine`：指标/条件评估与运行时间门禁。
- `MarketData.ContractDetailsCacheService`：合约精度与乘数。
- `Shared/Infrastructure/Config`：`ServerConfigStore` 提供回测限流配置项的实时读取。
- `Accounts`：`AuthTokenService` 用于 API 鉴权获取 userId。
