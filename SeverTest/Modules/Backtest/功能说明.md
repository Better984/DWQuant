# Backtest 模块功能说明

## 功能概述
- 提供策略回测入口，基于历史 K 线进行 Bar 驱动模拟。
- 复用指标/条件/动作执行链路，保证与实盘语义一致。
- 支持多标的交集时间轴、固定滑点、固定下单数量、止盈止损、自动反向。
- 输出交易明细、权益曲线、事件与统计结果（可裁剪）。

## 复用与最小侵入
- 历史 K 线读取优先级：
  - 首选：通过 `HistoricalMarketDataCache` 直接从历史行情缓存截取（区间模式与按根数模式均优先命中缓存）；
  - 次选：`IMarketDataProvider`（如 `MarketDataEngine`）读取运行态历史缓存；
  - 兜底：若缓存未命中或数据不足，回退到 `HistoricalMarketDataRepository` 直接读表（表名规则与 MarketData 一致）。
  - 回测日志会输出缓存命中/未命中与未命中原因（`reason`），便于定位是否发生了不必要的读表。
- 指标链路：`IndicatorEngine` / `IndicatorValueResolver`。
- 条件评估：`ConditionEvaluator` / `ConditionMethodRegistry`。
- 运行时间：`StrategyRuntimeSchedule`（支持模板/自定义时间段）。
- 动作执行：`ActionMethodRegistry` + `IStrategyActionExecutor`。
- 合约精度：`ContractDetailsCacheService`（下单数量精度与合约乘数）。

## 关键约束（MVP）
- 成交价：使用 1m K 线收盘价 + 固定滑点（bps）。
- 缺失 K 线：跳过，不补齐。
- 多标的：仅在所有标的都有该时间点才驱动（交集时间轴）。
- 资金模型：固定下单数量（`orderQty`），不做复杂资金管理。
- 不做逐笔撮合/盘口模型。

## 资金曲线输出优化
- 支持按粒度聚合资金曲线：`1m/15m/1h/4h/1d/3d/7d`。
- 聚合逻辑为“按时间桶落点”：每个桶仅保留末尾权益快照，避免每根 K 线都输出导致内存膨胀。
- 每个资金曲线点除累计值外，额外输出区间增量：
  - `periodRealizedPnl`：当前桶内已实现盈亏增量。
  - `periodUnrealizedPnl`：当前桶内未实现盈亏增量。
- 聚合后仍保留确定性：同样输入下，桶对齐与输出顺序固定。

## 统计口径
- 总收益 `TotalProfit`：交易明细 PnL 求和（已扣手续费）。
- 总收益率 `TotalReturn`：TotalProfit / 初始资金。
- 最大回撤 `MaxDrawdown`：权益曲线的峰值回撤比例。
- 胜率 `WinRate`：盈利交易数 / 交易总数。
- 交易次数 `TradeCount`。
- 平均盈亏 `AvgProfit`：TotalProfit / TradeCount。
- 盈亏比 `ProfitFactor`：盈利总和 / |亏损总和|。
- 平均盈利 `AvgWin`，平均亏损 `AvgLoss`。

## 调试日志
- 回测链路新增性能分析日志，统一前缀：`回测系统Log：`，便于排查耗时瓶颈。
- 日志覆盖参数解析、K 线加载、交集时间轴、主循环拆分与收尾统计。
- 主循环拆分中包含逻辑执行耗时分解（Entry/Exit 及过滤/检查/动作）。
- 当“历史行情系统数据不足”发生回退时，日志会额外输出：`requestRange`、`providerRange`、`missingDetail`、`reasonHint`，用于定位缺口位置（左侧/右侧/内部）。
- 为避免日志本身影响回测性能，逐 K 线的 `Debug` 级细节日志默认关闭。

## 回测实时推送
- 当用户已建立 WebSocket 连接时，回测链路会推送 `backtest.progress`。
- 推送与 HTTP 请求共享 `reqId`，前端按 `reqId` 过滤并展示当前任务阶段。
- 阶段推送覆盖：参数解析、策略构建、K 线加载、交集构建、主循环、仓位汇总、完成/失败。
- 仓位汇总阶段支持 0.1 秒节流增量推送：
  - 推送当前已发现仓位数量；
  - 可携带增量仓位详情（测试阶段用于快速预览）；
  - 最终仍以 `backtest.run` 完整响应结果为准。
- 若用户无 WebSocket 连接，推送自动跳过，不影响回测主流程。

## 主要入口
- `Application/BacktestService.cs`
- `Application/BacktestRunner.cs`
- `Controllers/BacktestController.cs`
- `Domain/BacktestModels.cs`

## 联动关系
- `MarketData`：历史行情缓存截取 + 历史行情表读取。
- `StrategyEngine`：指标/条件评估与运行时间门禁。
- `MarketData.ContractDetailsCacheService`：合约精度与乘数。
